# Story 4.14: Expense Reports - Scheduled Reports

## Status
Ready for Review

## Story
As a manager,
I want to schedule reports and email them to recipients,
So that stakeholders receive updates automatically.

## Acceptance Criteria
1. Report Scheduler
   - Configure frequency
   - Recipient management
   - Time zone support
2. Email Integration
   - HTML email preview
   - Attachment options
   - Delivery confirmation

## Tasks / Subtasks
- [ ] Build scheduler UI and backend integration
  - [ ] Cron expression builder UI
  - [ ] Visual schedule preview calendar
  - [ ] Timezone picker with DST handling
  - [ ] Schedule conflict detection
  - [ ] Pause/resume schedules
- [ ] Implement recipient lists and permissions
  - [ ] Email group management
  - [ ] Role-based distribution
  - [ ] External email validation
  - [ ] Unsubscribe handling
  - [ ] Bounce management
- [ ] Generate HTML previews and attach exports
  - [ ] Responsive email templates
  - [ ] Inline chart thumbnails
  - [ ] Multiple attachment formats
  - [ ] Compressed attachments for large reports
  - [ ] Cloud link option instead of attachments
- [ ] Real-time status and monitoring
  - [ ] Delivery status tracking
  - [ ] Open/click analytics
  - [ ] Failed delivery retry
  - [ ] Report generation logs

## Dev Notes
- Reference: `docs/implementation-plans/expense-reports-ui-improvement-plan.md` (Phase 4 - Task 4.2)
- Use existing email infrastructure if available
- Architecture:
  - Cron job service (node-cron or Supabase scheduled functions)
  - Email queue with retry logic
  - Template engine for HTML emails
- Services:
  - Resend/SendGrid for email delivery
  - Cloud storage for large attachments
  - Analytics for tracking
- Performance:
  - Support 100+ concurrent schedules
  - Email generation: <5s
  - Batch sending for multiple recipients
- Guest House Context:
  - Daily expense summary (9 AM)
  - Weekly budget status (Monday morning)
  - Monthly financial report (1st of month)
  - Seasonal analysis (quarterly)
  - Property comparison (weekly for multi-property)
- Compliance:
  - CAN-SPAM compliance
  - GDPR for EU guests
  - Unsubscribe in all emails

## Testing
- [ ] Validate schedules fire at correct times/zones
- [ ] Email content, attachments, and confirmations
- [ ] Error handling and retries
- [ ] DST transitions handled correctly
- [ ] Large recipient lists (50+)
- [ ] Attachment size limits
- [ ] Email rendering in major clients
- [ ] Mobile email responsiveness
- [ ] Unsubscribe functionality
- [ ] Schedule modification while running
- [ ] Performance under load
- [ ] Analytics tracking accuracy

## Success Metrics
- Schedule adoption: >40% set up automated reports
- Delivery rate: >95% successful delivery
- Open rate: >60% for scheduled reports
- Time saved: 5 hours/week per property

## Integration Points
- Filter presets: Use in scheduled reports
- Custom dashboards: Schedule any dashboard
- Export formats: All formats available
- Notifications: Alert on delivery issues
- Multi-property: Property-specific schedules

## Dependencies
- 4.17: Real-time Updates & Auto-refresh — consistent snapshotting for runs while live data changes
- 4.18: Dark Mode & Print Support — print CSS and high-contrast templates for PDF attachments
- 4.19: PWA & Offline Support — offline schedule drafting and background sync of queued jobs (client)
- 4.20: Mobile UI Enhancements — mobile-friendly schedule editor and time pickers
- 4.21: Chart Export & Sharing — chart image capture and export settings reused in attachments
- 4.24: Mobile Push Notifications — run success/failure push alerts and quiet hours
- 4.25: React Query + TanStack Table — list/paginate schedules with caching and revalidation
- 4.22/4.23: Weather & Local Events — optional annotations/overlays included in scheduled outputs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation | Team |
| 2025-08-16 | 1.1 | Added monitoring, guest house schedules, compliance | Enhancement |
