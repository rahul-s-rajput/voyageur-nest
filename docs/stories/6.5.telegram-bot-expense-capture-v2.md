# Story: Telegram Bot - Expense Capture v2 (Manual vs Receipt)

Status: In Progress

## Goal
Enhance `/expense` to support two modes:
- Manual entry (category → total → vendor → date → currency → line items → summary → confirm)
- From receipt (upload photo → AI extraction → prefill → summary → confirm or edit)

Default the saved expense to the active property and create a default property share of 100% in `public.expense_shares`.

## Feasibility Summary
- Line items supported via `public.expense_line_items` and service methods.
- Property shares supported via `public.expense_shares` (percent or fixed amount).
- Receipts bucket `receipts` exists with proper policies.
- Frontend-only receipt extraction exists; add a Deno-compatible extractor for Edge.

## UX Flow
- `/expense` shows inline keyboard:
  - [Manual Entry]
  - [From Receipt]

- Manual:
  - Category (optional with quick-pick)
  - Total amount
  - Vendor (optional)
  - Date (default today)
  - Currency (default property or INR)
  - Line items loop: Add item (description → qty → unit price → compute line total), repeat or done
  - Summary: show totals and any mismatch vs manual total, confirm to save

- Receipt:
  - Ask to send photo
  - Upload to `receipts/{propertyId}/{yyyy-mm}/{uuid}.ext`
  - Call Deno `receipt-extractor` (Gemini REST) to parse amount/date/currency/vendor/category_hint/line_items
  - Prefill wizard; show summary; confirm or switch to manual edit

- Save:
  - Insert into `public.expenses`
  - Insert line items into `public.expense_line_items` (if any)
  - Insert default share row into `public.expense_shares` (100% for active property)

## State Keys
- `exp_mode` = `manual` | `receipt`
- `exp_category_id` | `exp_category_name`
- `exp_amount_total`
- `exp_vendor`
- `exp_date`
- `exp_currency`
- `exp_receipt_path`
- `exp_items`: Array<{ description, quantity, unit_amount, tax_amount?, line_total? }>
- `exp_extracted`: AI extraction blob (optional)

## Implementation Plan
1) Add Deno extractor: `supabase/functions/telegram-bot/lib/receipt-extractor.ts`
   - `extractFromReceipt(bytes, hints?)` → normalized result
   - Env: `GEMINI_API_KEY`, `GEMINI_MODEL` (optional)

2) Extend feature file: `supabase/functions/telegram-bot/features/expense.ts`
   - Mode selection with inline keyboard and callbacks
   - Manual flow steps and line items loop (add item → desc/qty/unit)
   - Receipt flow: photo → upload → extract → prefill → summary → confirm
   - On save: insert expense, then line items, then default property share

3) Category quick-pick suggestions
   - Inline keyboard of recent/known categories during category step

4) Testing
   - Manual path: invalid amount/date, add multiple items, reconcile totals
   - Receipt path: good and complex receipts, extractor failure fallback to manual
   - Verify DB rows in `expenses`, `expense_line_items`, `expense_shares`
   - Verify storage object path

## Security & Env
- `GEMINI_API_KEY` required for receipt path
- Edge function runs with service role; storage bucket policies applied

## Rollout
- Deploy: `supabase functions deploy telegram-bot --no-verify-jwt`
- Add `GEMINI_API_KEY` to function env

## Open Questions / Future Enhancements
- Shares split across multiple properties (percent vs fixed amount UI)
- Edit/remove individual line items in Telegram (beyond add/done)
- Localization of prompts and summaries
