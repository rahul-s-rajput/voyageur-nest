# Story 5.1: Digital Menu Management

## Status
- **Current Status**: Ready for Development
- **Priority**: High
- **Epic**: 5 - Food & Beverage Management System
- **Story Points**: 13
- **Assigned Dev Agent**: TBD
- **Sprint**: TBD

## User Story
**As a** property manager  
**I want** to manage menus digitally with proper categorization  
**So that** I can update prices and availability easily

## Business Context
The properties operate an in-house F&B program. Today, menus are static and edits are manual. This story establishes a property-aware digital menu with categorized items, photos, veg/non‑veg indicators, availability toggles, cost tracking, seasonal flags, and basic multilingual support. It prepares the foundation for Room Service Ordering (Story 5.2) and downstream analytics in Epic 6.

## Scope
- In-scope:
  - Property-scoped menu categories and items (CRUD)
  - Photo uploads for items to Supabase Storage with validation/compression
  - Real-time price/availability updates in the admin UI
  - Availability toggle per item
  - Cost fields for profit analysis; currency support
  - Veg/non‑veg classification and basic dietary/allergen info
  - Simple multilingual fields (name/description) for English/Hindi
  - Seasonal flags (e.g., winter/summer) and tags
  - Integration with PropertyContext and Admin dashboard navigation
  - Public menu display (read-only) that matches the provided reference structure and is mobile-friendly
- Out-of-scope (covered by other stories):
  - Guest-facing ordering flows (Story 5.2)
  - Kitchen display and order ticketing (Story 5.3)
  - Advanced inventory/recipe cost breakdowns and supplier management
  - Deep i18n for arbitrary languages beyond EN/HI

## Non‑Goals
- Building a full e-commerce checkout
- Complex tax rules and KOT/billing integration
- Ingredient-level stock management

## Architecture Overview
- **Frontend**: React + TypeScript. Property-aware via `PropertyContext`. New F&B components under `src/components/FnB/`.
- **Storage**: Supabase Storage new private bucket `menu-photos` with `EnhancedFileValidator` and client-side compression (reuse `StorageService` pattern or a dedicated minimal wrapper).
- **Database**: New property-scoped tables: `menu_categories`, `menu_items`, optional `menu_item_options` (future). JSONB for simple multilingual fields and dietary data.
- **Service Layer**: New `menuService.ts` for CRUD and listing with property filters; mirrors patterns from `propertyService.ts` and `expenseService.ts`.
- **Real-time**: Enable Realtime on new tables for instant UI refresh on price/availability edits.
- **Security/RLS**: Enable RLS on new tables; dev-permissive policies for SELECT/INSERT/UPDATE similar to existing patterns, with property_id scoping as we mature.
- **Translations**: UI strings via existing translation service; data translations stored per-record (JSONB), not in UI translation tables.

## Acceptance Criteria
- **Categories (pre-seeded and manageable)**
  - Matches Voyageur Nest categories from final epics:  
    Hot Beverages, Cool Refreshments, Shakes & Lassis; Egg Delights; Parantha; Toasts and Spreads; Soups; Sandwiches & Burgers; Chinese; Indian Main Course; Indian Breads and Rice; Salads & Raita; Thali
  - Can add/edit/rename, reorder, activate/deactivate categories per property
  - Sort order is persisted and respected in UI

- **Items CRUD with Photos**
  - Add/edit/delete items under a category
  - Upload a single primary photo per item (JPEG/PNG/WebP, max 5–10MB), compressed client-side
  - Validation via `EnhancedFileValidator` (type, size, magic bytes, dimensions)
  - Photos are private in `menu-photos` bucket; signed URL retrieval handled by service

- **Real-time Price & Availability**
  - Editing price or availability reflects immediately in the admin menu list
  - Price field supports currency (default INR); validation with 2 decimal precision
  - Availability toggle updates item state without full page refresh

- **Cost Tracking for Profit Analysis**
  - Each item supports an optional `cost` field (per-plate cost) for profit margin analysis (Epic 6)
  - Profit margin = (price − cost) / price is accessible in reporting later

- **Veg/Non‑Veg and Dietary Info**
  - Items can be flagged veg/non‑veg; veg icon indicator shown in UI
  - Optional allergens and ingredient notes (simple text/arrays)

- **Multi-language Support (EN/HI)**
  - Item `name` and `description` support EN/HI via JSONB `name_i18n`/`description_i18n`
  - UI labels and controls localized via existing translation service

- **Seasonality & Tags**
  - Seasonal flags (e.g., `winter`, `summer`) to filter and plan menus
  - Freeform `tags` array for quick filtering (e.g., spicy, popular)

- **Property-Aware**
  - All data is scoped by `property_id`; switching properties via `PropertySelector` changes menu context

- **Public Display Structure & Responsive Design (must match the provided reference)**
  - Desktop (>= 1024px):
    - Category navigation rendered as top tabs (single row). Active tab highlighted.
    - Items for the active category show in a 3-column grid (falls back to 2 columns if width < 1280px).
    - Each item row shows Name on the left and Price on the right with dotted leaders in between.
    - Page title “Menu” centered, matching check-in page typography scale.
  - Tablet (768–1023px):
    - Category tabs remain at top, items displayed in a 2-column grid.
  - Mobile (< 768px):
    - Category navigation converts to an accordion list (collapsed by default). The first category opens initially.
    - Items displayed in a single column with dotted leaders between name and price.
    - Expand/collapse icons (+/×) match the reference.
  - Accessibility:
    - Tabs and accordions are keyboard accessible (arrow keys/tab order) and have ARIA roles and states.

- **Admin UX**
  - Responsive management UI (desktop/tablet)
  - Bulk availability toggle in category view
  - Clear error/success notifications via existing `NotificationProvider`

## Definition of Done
- New tables created with RLS enabled and realtime publication added
- `menuService.ts` provides typed CRUD and listing with property filters
- `MenuManagement.tsx` renders categories and items and supports inline edits
- Photo upload uses validated, compressed client-side processing into `menu-photos`
- Admin navigation exposes a “Menu” (or “F&B”) section; property switching works end-to-end
- Public read-only `MenuPage.tsx` replicates the reference structure (desktop tabs + mobile accordion), dotted leaders, and responsive grid
- Unit/integration tests in place per Test Plan
- Linting/TypeScript pass cleanly; basic accessibility checks

## Database Schema (proposed)
```sql
-- Categories per property
CREATE TABLE IF NOT EXISTS public.menu_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  slug TEXT GENERATED ALWAYS AS (regexp_replace(lower(name), '[^a-z0-9]+', '-', 'g')) STORED,
  sort_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(property_id, name)
);

-- Items per property/category
CREATE TABLE IF NOT EXISTS public.menu_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
  category_id UUID NOT NULL REFERENCES menu_categories(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  name_i18n JSONB DEFAULT '{}',         -- {"en": "Tea", "hi": "चाय"}
  description TEXT,
  description_i18n JSONB DEFAULT '{}',  -- {"en": "Hot tea", "hi": "गरम चाय"}
  price NUMERIC(10,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'INR',
  cost NUMERIC(10,2),                   -- optional cost for profit analysis
  is_available BOOLEAN DEFAULT true,
  is_veg BOOLEAN DEFAULT true,
  allergens TEXT[] DEFAULT '{}',
  ingredients TEXT[] DEFAULT '{}',
  seasonal_flags JSONB DEFAULT '[]',    -- ["winter", "summer"]
  tags TEXT[] DEFAULT '{}',
  photo_path TEXT,                      -- Supabase Storage object path
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Triggers
CREATE OR REPLACE FUNCTION update_updated_at_column() RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END; $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_menu_categories_updated_at ON public.menu_categories;
CREATE TRIGGER trg_menu_categories_updated_at
BEFORE UPDATE ON public.menu_categories
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS trg_menu_items_updated_at ON public.menu_items;
CREATE TRIGGER trg_menu_items_updated_at
BEFORE UPDATE ON public.menu_items
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- RLS (start permissive; tighten later with property scoping)
ALTER TABLE public.menu_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.menu_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY menu_categories_read ON public.menu_categories FOR SELECT USING (true);
CREATE POLICY menu_categories_write ON public.menu_categories FOR INSERT WITH CHECK (true);
CREATE POLICY menu_categories_update ON public.menu_categories FOR UPDATE USING (true);

CREATE POLICY menu_items_read ON public.menu_items FOR SELECT USING (true);
CREATE POLICY menu_items_write ON public.menu_items FOR INSERT WITH CHECK (true);
CREATE POLICY menu_items_update ON public.menu_items FOR UPDATE USING (true);

-- Realtime
ALTER PUBLICATION supabase_realtime ADD TABLE public.menu_categories;
ALTER PUBLICATION supabase_realtime ADD TABLE public.menu_items;

-- Seed default categories for properties (optional, run once)
-- Hot Beverages, Cool Refreshments, Shakes & Lassis, Egg Delights, Parantha, Toasts and Spreads,
-- Soups, Sandwiches & Burgers, Chinese, Indian Main Course, Indian Breads and Rice, Salads & Raita, Thali
```

## Service Layer (proposed)
- `src/services/menuService.ts`
  - `listCategories(propertyId: string): Promise<MenuCategory[]>`
  - `createCategory(propertyId: string, input: { name: string; isActive?: boolean; sortOrder?: number }): Promise<MenuCategory>`
  - `updateCategory(id: string, updates: Partial<MenuCategory>): Promise<MenuCategory>`
  - `reorderCategories(propertyId: string, categoryIdsInOrder: string[]): Promise<void>`
  - `listItems(params: { propertyId: string; categoryId?: string; search?: string; availableOnly?: boolean }): Promise<MenuItem[]>`
  - `createItem(input: CreateMenuItemInput): Promise<MenuItem>`
  - `updateItem(id: string, updates: Partial<MenuItem>): Promise<MenuItem>`
  - `deleteItem(id: string): Promise<void>`
  - `getSignedPhotoUrl(photoPath: string): Promise<string>`

- Storage helpers (option A): extend `StorageService` with a generic `uploadToBucket(bucketName: string, path: string, file: File)`
- Storage helpers (option B): `menuStorageService.ts` encapsulating `menu-photos` logic and validation profile (images only)

## UI Components (proposed)
Directory: `src/components/FnB/`

Admin (management):
- `MenuManagement.tsx`: entry screen with two panes: category management and item grid; supports inline availability/price edits
- `MenuCategoryList.tsx`: list, reorder (drag), add/edit, activate/deactivate
- `MenuItemGrid.tsx`: responsive card/list of items in selected category with inline availability toggle and price editing
- `MenuItemForm.tsx`: create/edit item with photo upload, veg toggle, cost, currency, seasonal flags, tags, allergens, ingredients, translations (EN/HI)
- `MenuPhotoUploader.tsx`: wraps file selection + preview + validated upload
- `PriceEditor.tsx`: numeric input with INR default and validation
- `VegBadge.tsx`: badge/icon renderer for veg/non‑veg

Public (read-only display):
- `MenuPage.tsx` with the following behavior:
  - Top-centered title “Menu” using the same typographic scale as the check-in page
  - Desktop/tablet: horizontal category tabs at top; items render as 3/2-column responsive grid
  - Mobile: accordion per category (collapsed by default); first category expanded
  - Dotted leader between item name and price
  - Uses property branding colors (`properties.branding.theme_color`/`secondary_color`) and the check-in page’s spacing/radius/heading styles for visual cohesion

Admin integration:
- Add a new Admin tab (“Menu” or “F&B”) in `AdminPage.tsx` and `MobileNavigation.tsx`, rendering `<MenuManagement />`
- Ensure `PropertySelector` remains visible; all calls pass `currentProperty.id`

## Design System Alignment
- Typography, spacing, and button styles mirror the check-in page for a cohesive feel
- Colors sourced from `properties.branding` with fallbacks to Tailwind defaults
- Optional: reuse `EtherealHero` for the public menu header to match the check-in hero treatment
- Dotted leaders implemented via CSS background or pseudo-element to ensure robust wrapping on mobile

## Data Types (proposed)
Add to `src/types/`:
- `fnb.ts`
  - `MenuCategory`
  - `MenuItem`
  - `CreateMenuItemInput`
  - Enums: `SeasonFlag = 'winter' | 'summer' | 'monsoon' | 'peak' | 'offpeak'`

## Translations
- UI keys under `fnb.menu.*` (e.g., `fnb.menu.title`, `fnb.menu.addItem`, `fnb.menu.category.hotBeverages`)
- Use `databaseTranslationService` for UI labels; item names/descriptions translated via `*_i18n` JSONB in data

## Security & Validation
- File upload: `EnhancedFileValidator` (type, size, magic number, dimensions) + compression
- Bucket `menu-photos` private; use signed URLs for display in admin/public pages
- RLS enabled; begin permissive similar to existing migrations; plan to restrict to authenticated/admin roles for writes
- Input validation in forms (required fields, price/cost numeric constraints)

## Performance Considerations
- Virtualized lists for large menus (future)
- Throttled inline edits for price/availability
- Signed URL caching per session to reduce repeated requests

## Monitoring & Notifications
- Show success/error via `NotificationProvider`
- Optional: Emit an in-app notification when category/item is created/updated for audit trail

## Test Plan
- Unit tests
  - `menuService` CRUD and transformation
  - Validation utilities for price/cost and i18n payloads
  - Storage helper for photo upload pathing
- Component tests
  - `MenuManagement` renders categories/items and responds to property switching
  - `MenuItemForm` validation: required fields, veg toggles, price/cost constraints
  - Photo uploader handles rejection/acceptance via `EnhancedFileValidator`
  - `MenuPage` renders category tabs, applies active tab styles, and shows dotted leaders
- Integration tests
  - Create category → add items → toggle availability → edit price → realtime UI reflects changes
  - Property switching isolates data by `property_id`
  - Responsive behavior: 
    - Desktop ≥1024px: tabs visible, 3-col grid
    - Tablet 768–1023px: tabs visible, 2-col grid
    - Mobile <768px: accordion replaces tabs; first section expanded; keyboard/ARIA behavior verified

## Rollout Plan
- Phase A: Schema + Service + Admin UI + Public `MenuPage` (EN), photo upload, availability + price editing
- Phase B: Hindi name/description fields; seasonal flags/tags; allergens/ingredients
- Phase C: Realtime polish; signed URL caching; a11y improvements

## Tasks / Subtasks
- T1: Database Migration
  - [ ] Create migration `menu_management_migration.sql` for `menu_categories`/`menu_items`, triggers, RLS, publication
  - [ ] Optional seed categories and initial items per property (per provided reference)
- T2: Storage Setup
  - [ ] Create private bucket `menu-photos` (apply script update)
  - [ ] Extend storage helper or add `menuStorageService.ts` with validator profile (images only)
- T3: Service Layer
  - [ ] Implement `menuService.ts` with typed interfaces and CRUD
  - [ ] Signed URL retrieval for photos
- T4: UI – Admin
  - [ ] Build `MenuManagement.tsx` with category-and-items layout
  - [ ] Forms for category and item create/edit with validations
  - [ ] Inline availability and price edits with optimistic updates
  - [ ] Photo uploader component
- T5: UI – Public
  - [ ] Build `MenuPage.tsx` with desktop tabs / mobile accordion, dotted leaders, and responsive grid matching reference and check-in styles
- T6: Admin Integration
  - [ ] Add “Menu/F&B” tab in `AdminPage.tsx` and `MobileNavigation.tsx`
  - [ ] Ensure `PropertySelector` drives property context for all calls
- T7: Translations
  - [ ] Add UI keys under `fnb.menu.*` (EN/HI)
- T8: Tests
  - [ ] Unit/component/integration tests per plan
- T9: Documentation
  - [ ] Update README/admin guide for menu management usage

## Open Questions
- Do we need per-variant options (size/spice levels) now, or defer to a later story?
- Any special tax/price display rules for guest-facing menus later?
- Standardize seasonal flags list vs freeform?
- Max photo size and dimension policy (current validator defaults are 10MB and 4k)?

## Risks & Mitigations
- Large images → enforce compression and size caps
- RLS too permissive initially → align with existing auth/RLS tightening pass post-MVP
- Category renames/slug collisions → enforce unique `(property_id, name)` and stable IDs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.1 | Align structure to desktop tabs/mobile accordion + check-in styling | Planning Agent |
| 2025-01-XX | 1.0 | Initial story creation for Digital Menu Management | Planning Agent |
