# Status
Planned

# Story: Telegram Bot - Quick Reports & KPIs
Provide `/report` to show a small set of KPIs (e.g., occupancy today, ALOS, revenue this month) leveraging existing analytics services where feasible.

## Prerequisites
- `6.1`â€“`6.2` completed.
- Bot refactor is in place: `supabase/functions/telegram-bot/index.ts` registers modular features.
- Implement this story as a new feature module: `supabase/functions/telegram-bot/features/report.ts` (or `features/reports.ts`) and register it from `index.ts`.
- Inject dependencies from `index.ts`: `{ supabase, BOT_TIMEZONE, formatDateInTZ, getSelectedPropertyId }`.
- App analytics services exist in the web app (`src/services/analytics/bookingAnalyticsService.ts`, `src/services/analytics/kpiCalculator.ts`). Reuse only if extracted into a Deno-compatible shared module (no React/browser-specific deps).

## Acceptance Criteria
- `/report` returns a concise text summary of 3â€“5 KPIs for the selected property.
- Handles lack of data gracefully (e.g., "N/A").
- Returns within ~1â€“2 seconds for typical dataset.
- Date-based calculations (e.g., "today", current month) use IST (Asia/Kolkata) by default; overridable via `BOT_TIMEZONE`.

## Tasks
- Command `/report`
  - Add `registerQuickReports(bot, deps)` in `features/report.ts` and register from `index.ts`.
  - Prefer computing quick summaries directly from `bookings` (and `expenses` if needed) using minimal queries compatible with Deno Edge Functions.
  - If reusing app analytics: move the needed pure functions into a shared Deno-friendly module and import it here.
  - Format a compact text block with emoji bullets.
- Performance
  - Keep queries minimal; for "this month" KPIs, consider a bounded window (e.g., last 30â€“60 days) if exact month filtering is expensive.
- Date handling
  - Compute dates via `formatDateInTZ(d, BOT_TIMEZONE)` from `supabase/functions/telegram-bot/utils.ts`.

## Dev Notes
- KPI examples (pick 3â€“5):
  - ALOS (Average Length of Stay)
  - Occupancy today (rooms occupied/total)
  - Total bookings this month
  - Revenue this month (sum of `total_amount` for non-cancelled)
  - Unpaid dues (sum filtered by `payment_status = 'unpaid'` if present)
  - Optional (if counts available cheaply): cancellation rate, repeat guest rate

- Example skeleton:
  ```ts
  // features/report.ts
  import type { Bot } from "https://deno.land/x/grammy/mod.ts";
  export function registerQuickReports(bot: Bot, deps: { supabase: any; BOT_TIMEZONE: string; formatDateInTZ: (d: Date, tz: string)=>string; getSelectedPropertyId: (ctx:any)=>Promise<string|null>; }) {
    const { supabase, BOT_TIMEZONE, formatDateInTZ, getSelectedPropertyId } = deps;
    bot.command("report", async (ctx) => {
      const pid = await getSelectedPropertyId(ctx); if (!pid) return;
      const today = formatDateInTZ(new Date(), BOT_TIMEZONE);
      const ym = today.slice(0,7); // YYYY-MM
      const [todayQ, monthQ] = await Promise.all([
        supabase.from("bookings")
          .select("id, room_no, total_amount, status, cancelled, check_in, check_out")
          .eq("property_id", pid)
          .or(`check_in.eq.${today},check_out.eq.${today}`),
        supabase.from("bookings")
          .select("id, total_amount, status, cancelled, check_in, check_out")
          .eq("property_id", pid)
          .gte("check_in", `${ym}-01`) // simple month window (approx)
      ]);
      const todayRows = todayQ.data ?? [];
      const monthRows = monthQ.data ?? [];
      // Compute KPIs (filter out cancelled where needed)
      const occupiedToday = todayRows.filter(b => !b.cancelled && (b.check_in === today || b.check_out === today)).length;
      const revenueMonth = monthRows.filter(b => !b.cancelled).reduce((s,b)=> s + (Number(b.total_amount)||0), 0);
      // ALOS (example): average of (check_out - check_in) across monthRows where valid
      const stays = monthRows.filter(b => !b.cancelled && b.check_in && b.check_out);
      const alos = stays.length ? (stays.reduce((s,b)=> s + (new Date(b.check_out).getTime()-new Date(b.check_in).getTime())/(1000*60*60*24), 0) / stays.length) : 0;
      const lines = [
        `ğŸ“Š Quick KPIs`,
        `ğŸ¨ Occupancy (today): ${occupiedToday}`,
        `ğŸ’° Revenue (month): ${revenueMonth.toFixed(0)}`,
        `ğŸ“ ALOS (month): ${alos.toFixed(2)}`,
      ];
      await ctx.reply(lines.join("\n"));
    });
  }
  ```
 - Prefer simplified queries by default to avoid heavy dependencies.

## Testing
- Seed test data across two months; verify KPIs match web app where applicable.
- Verify message fits mobile screen and is readable.

## Change Log
- 2025-08-21: Initial story draft created.
 - 2025-08-22: Aligned with refactored Telegram bot (modular feature, DI, Deno-friendly analytics guidance).
