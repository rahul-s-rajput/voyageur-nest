# Status
In Progress

# Story: Telegram Bot - Bookings Quick Actions
Enable fast booking operations: create, modify, cancel. Keep flows minimal and optimized for mobile chat.

## Prerequisites
- `6.1.telegram-bot-foundation-auth.md`, `6.2.telegram-bot-property-switching.md`.
- Booking service: `src/services/roomBookingService.ts` and booking types in `src/types/booking.ts`.

## Acceptance Criteria
- `/book` starts a short booking wizard: guest name, room no, dates (check-in/out), amount.
- Bot validates required fields; confirms summary before create.
- Create booking via existing service or direct Supabase insert respecting schema and RLS.
- `/booking <id>` shows summary and offers inline actions: Modify, Cancel.
 - Cancel sets `cancelled = true` on the booking and confirms.

## Tasks
- Command `/book`
  - Implement a step-by-step state machine using grammY conversations or manual state map.
  - Use current property from context; include `propertyId` in inserts.
  - Use `roomBookingService` helpers where possible, else fallback to Supabase insert into `bookings`.
- Command `/booking`
  - Parse `<id>`; fetch and display core fields with action buttons.
  - Implement Modify flow for small changes (amount, dates) or send user to cancel+recreate for simplicity.
- Validations & UX
  - Basic date validation `checkIn < checkOut`.
  - Amount must be positive number.
  - Send clear success/failure messages.

## Dev Notes
- Insert example:
  ```ts
  const { data, error } = await supabase
    .from("bookings")
    .insert({
      property_id: propertyId,
      guest_name: input.guestName,
      room_no: input.roomNo,
      check_in: input.checkIn,
      check_out: input.checkOut,
      total_amount: input.amount,
      status: "confirmed",
    })
    .select("id").single();
  ```
- Cancel example:
  ```ts
  const { error } = await supabase
    .from("bookings")
    .update({ cancelled: true, updated_at: new Date().toISOString() })
    .eq("id", bookingId);
  ```
- Consider using a short-lived in-memory per-chat state for the wizard; keep prompts concise.

## Testing
- Happy path: create booking with valid fields; verify record in DB and shows in web app.
- Invalid date or amount inputs show inline correction prompts.
- Cancel flow sets `cancelled = true` and records `updated_at`.

## Change Log
- 2025-08-20: Implemented in `supabase/functions/telegram-bot/index.ts`:
  - `/book` wizard (guest name → room no → dates → amount → confirm) with validation and confirmation inline buttons. Inserts into `bookings` with `property_id` from context.
  - `/booking <id>` shows summary with inline actions: Cancel (updates `cancelled = true`) and placeholder Modify.
- 2025-08-21: Initial story draft created.
