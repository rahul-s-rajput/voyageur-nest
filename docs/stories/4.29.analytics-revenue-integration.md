# Story 4.29: Revenue Analytics Integration

## Status
Ready for Development

## Story
**As a** property manager  
**I want** detailed revenue analytics with breakdowns by source, property, and time period  
**So that** I can optimize pricing strategies and identify the most profitable channels  

## Acceptance Criteria
1. Display total revenue with accurate calculations from bookings
2. Show revenue breakdown by booking source (Direct, OTAs, etc.)
3. Provide revenue breakdown by property for multi-property view
4. Calculate and display revenue trends over time
5. Show revenue per available room (RevPAR) metrics
6. Compare revenue across different periods (MoM, YoY, Custom)
7. Identify top revenue-generating room types
8. Export revenue reports in PDF and Excel formats

## Tasks / Subtasks

- [ ] **Task 1: Revenue Data Service** (AC: 1, 2, 3)
  - [ ] Create src/services/analytics/RevenueAnalyticsService.ts
  - [ ] Implement fetchRevenueByDateRange method
  - [ ] Add fetchRevenueByProperty method
  - [ ] Create fetchRevenueBySource method
  - [ ] Implement revenue aggregation logic

- [ ] **Task 2: Revenue Calculations** (AC: 1, 5)
  - [ ] Implement gross revenue calculation
  - [ ] Add net revenue calculation (after cancellations)
  - [ ] Calculate RevPAR (Revenue Per Available Room)
  - [ ] Implement TRevPAR (Total Revenue Per Available Room)
  - [ ] Add revenue per booking calculation

- [ ] **Task 3: Source Analytics** (AC: 2, 7)
  - [ ] Create booking source categorization
  - [ ] Implement channel performance metrics
  - [ ] Calculate commission costs by channel
  - [ ] Add direct booking percentage tracking
  - [ ] Identify most profitable channels

- [ ] **Task 4: Trend Analysis** (AC: 4, 6)
  - [ ] Implement daily revenue tracking
  - [ ] Create weekly revenue aggregation
  - [ ] Add monthly revenue summaries
  - [ ] Build year-over-year comparison
  - [ ] Create custom period comparisons

- [ ] **Task 5: UI Components** (AC: All)
  - [ ] Update revenue KPI cards with real data
  - [ ] Create revenue trend chart component
  - [ ] Build channel performance pie chart
  - [ ] Add revenue comparison tables
  - [ ] Implement interactive tooltips

- [ ] **Task 6: Export Functionality** (AC: 8)
  - [ ] Create revenue report templates
  - [ ] Implement PDF generation
  - [ ] Add Excel export with charts
  - [ ] Include period comparisons in exports
  - [ ] Add scheduled report generation

## Dev Notes

### Revenue Calculation Methods
```typescript
export class RevenueCalculator {
  calculateGrossRevenue(bookings: Booking[]): number {
    return bookings
      .filter(b => b.status === 'confirmed')
      .reduce((sum, b) => sum + b.total_amount, 0);
  }

  calculateNetRevenue(bookings: Booking[]): number {
    const gross = this.calculateGrossRevenue(bookings);
    const refunds = bookings
      .filter(b => b.status === 'cancelled' && b.refund_amount)
      .reduce((sum, b) => sum + (b.refund_amount || 0), 0);
    
    return gross - refunds;
  }

  calculateRevPAR(revenue: number, availableRooms: number): number {
    return availableRooms > 0 ? revenue / availableRooms : 0;
  }

  calculateChannelRevenue(bookings: Booking[]): ChannelRevenue[] {
    const grouped = this.groupByChannel(bookings);
    
    return Object.entries(grouped).map(([channel, channelBookings]) => ({
      channel,
      revenue: this.calculateGrossRevenue(channelBookings),
      bookings: channelBookings.length,
      avgBookingValue: this.calculateAverageBookingValue(channelBookings),
      commission: this.calculateCommission(channel, channelBookings)
    }));
  }
}
```

### Revenue Breakdown Query
```sql
-- Optimized query for revenue analytics
WITH revenue_data AS (
  SELECT 
    b.property_id,
    b.booking_source,
    b.room_type,
    DATE_TRUNC('day', b.check_in) as revenue_date,
    b.total_amount,
    b.commission_amount,
    b.cancelled,
    b.refund_amount,
    p.name as property_name,
    p.total_rooms
  FROM bookings b
  JOIN properties p ON b.property_id = p.id
  WHERE b.check_in >= $1 AND b.check_out <= $2
    AND ($3::uuid[] IS NULL OR b.property_id = ANY($3))
)
SELECT 
  property_id,
  property_name,
  booking_source,
  COUNT(*) as booking_count,
  SUM(CASE WHEN NOT cancelled THEN total_amount ELSE 0 END) as gross_revenue,
  SUM(CASE WHEN cancelled THEN refund_amount ELSE 0 END) as refunds,
  SUM(commission_amount) as total_commission,
  AVG(total_amount) as avg_booking_value,
  COUNT(DISTINCT revenue_date) as active_days
FROM revenue_data
GROUP BY property_id, property_name, booking_source
ORDER BY gross_revenue DESC;
```

### Channel Performance Metrics
```typescript
interface ChannelMetrics {
  channel: string;
  revenue: number;
  bookings: number;
  conversionRate: number;
  avgBookingValue: number;
  avgLengthOfStay: number;
  cancellationRate: number;
  netRevenue: number;
  profitMargin: number;
}

export class ChannelAnalyzer {
  analyzeChannelPerformance(
    bookings: Booking[],
    inquiries: Inquiry[]
  ): ChannelMetrics[] {
    const channels = this.getUniqueChannels(bookings);
    
    return channels.map(channel => {
      const channelBookings = bookings.filter(b => b.source === channel);
      const channelInquiries = inquiries.filter(i => i.source === channel);
      
      return {
        channel,
        revenue: this.calculateRevenue(channelBookings),
        bookings: channelBookings.length,
        conversionRate: this.calculateConversion(channelBookings, channelInquiries),
        avgBookingValue: this.calculateAvgValue(channelBookings),
        avgLengthOfStay: this.calculateAvgLOS(channelBookings),
        cancellationRate: this.calculateCancellationRate(channelBookings),
        netRevenue: this.calculateNetRevenue(channelBookings),
        profitMargin: this.calculateProfitMargin(channelBookings)
      };
    });
  }
}
```

### Revenue Trend Analysis
```typescript
export class RevenueTrendAnalyzer {
  analyzeTrends(data: RevenueData[]): TrendAnalysis {
    const daily = this.calculateDailyTrend(data);
    const weekly = this.calculateWeeklyTrend(data);
    const monthly = this.calculateMonthlyTrend(data);
    
    return {
      daily: {
        data: daily,
        trend: this.detectTrend(daily),
        forecast: this.forecastNextPeriod(daily, 7)
      },
      weekly: {
        data: weekly,
        trend: this.detectTrend(weekly),
        avgGrowth: this.calculateAvgGrowth(weekly)
      },
      monthly: {
        data: monthly,
        trend: this.detectTrend(monthly),
        seasonality: this.detectSeasonality(monthly)
      },
      insights: this.generateTrendInsights(daily, weekly, monthly)
    };
  }

  private detectTrend(data: TimeSeriesData[]): Trend {
    const recentData = data.slice(-10);
    const slope = this.calculateSlope(recentData);
    
    if (Math.abs(slope) < 0.02) return 'stable';
    return slope > 0 ? 'increasing' : 'decreasing';
  }
}
```

### UI Component Updates
```typescript
export const RevenueAnalytics: React.FC = () => {
  const { data, isLoading } = useRevenueAnalytics();
  
  if (isLoading) return <LoadingSkeleton />;
  
  return (
    <div className="space-y-6">
      {/* Revenue KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <KPICard
          title="Total Revenue"
          value={formatCurrency(data.totalRevenue)}
          change={data.revenueChange}
          icon={<DollarSign />}
        />
        <KPICard
          title="RevPAR"
          value={formatCurrency(data.revpar)}
          change={data.revparChange}
          icon={<TrendingUp />}
        />
        <KPICard
          title="Avg Booking Value"
          value={formatCurrency(data.avgBookingValue)}
          change={data.abvChange}
          icon={<Receipt />}
        />
        <KPICard
          title="Direct Bookings"
          value={`${data.directBookingPct}%`}
          change={data.directChange}
          icon={<Globe />}
        />
      </div>

      {/* Revenue Trend Chart */}
      <Card>
        <CardHeader>
          <CardTitle>Revenue Trend</CardTitle>
        </CardHeader>
        <CardContent>
          <RevenueTrendChart data={data.trend} />
        </CardContent>
      </Card>

      {/* Channel Performance */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <ChannelPieChart data={data.channels} />
        <ChannelPerformanceTable data={data.channelMetrics} />
      </div>

      {/* Property Comparison */}
      {data.properties.length > 1 && (
        <PropertyRevenueComparison properties={data.properties} />
      )}
    </div>
  );
};
```

## Testing

### Test Requirements
- **Unit Tests**: Revenue calculations, channel analysis
- **Integration Tests**: Database queries, data aggregation
- **Performance Tests**: Large dataset processing
- **Accuracy Tests**: Financial calculations precision

### Test Scenarios
```typescript
describe('RevenueAnalytics', () => {
  it('calculates gross revenue correctly');
  it('handles refunds and cancellations');
  it('aggregates multi-property revenue');
  it('identifies channel performance accurately');
  it('detects revenue trends');
  it('generates accurate forecasts');
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Analytics Team |

---

## Linked Issues
- Depends on: Story 4.27 (KPI Calculation Engine)
- Enhances: Dashboard revenue displays
- Related: Story 4.13 (Export Options)
