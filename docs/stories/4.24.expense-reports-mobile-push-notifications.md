# Story 4.24: Mobile Push Notifications (Budgets & Anomalies)

## Status
Ready for Review

## Story
As a manager on the go,
I want push notifications for budget alerts and anomalies,
So that I can act quickly from my phone.

## Acceptance Criteria
1. Opt-in & Preferences
   - Permission prompt with clear value proposition
   - Per-user preferences: budgets, anomalies, schedules
   - Quiet hours, frequency caps
2. Delivery
   - Web Push via service worker
   - Payload includes deep link to relevant report
   - Badge count and grouping by property
3. Reliability
   - Retry/backoff; delivery confirmations logged
   - Fallback email for critical alerts

## Tasks / Subtasks
- [ ] Client
  - [ ] `NotificationOptIn` UI + `useNotifications`
  - [ ] Register service worker and subscribe with VAPID key
  - [ ] Store subscription on server (per property)
- [ ] Service Worker
  - [ ] Extend `public/notifications-sw.js` to handle alert types
  - [ ] Click actions open deep links; analytics events
- [ ] Server/Functions
  - [ ] Alert triggers for budget threshold (Story 4.10)
  - [ ] Anomaly alerts (Story 4.11)
  - [ ] Queue + retry; unsubscribe handling

## Dev Notes
- Existing assets: `public/notifications-sw.js`, `public/vapid-public-key.json`
- Suggested locations:
  - `src/lib/push.ts`
  - `src/components/Reports/NotificationOptIn.tsx`
  - `supabase/functions/push-alerts/` (or server-equivalent)
- Privacy: show what data is sent; easy opt-out

## Testing
- [ ] Permission flows; deny/allow changes
- [ ] Receive notifications when app closed
- [ ] Deep link opens specific dashboard/filter
- [ ] Quiet hours respected; frequency caps enforced

## Success Metrics
- Opt-in rate: >30% of mobile users
- Critical alert delivery success: >95%

## Integration Points
- Budget thresholds, anomalies, scheduled reports
- PWA (Story 4.19) for better install/notification UX

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation | Team |
