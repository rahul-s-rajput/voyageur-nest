# 4.33 Operational Compliance – Today’s Check-in/Check-out Enforcement (Alerts, No Automation)

## Status
Proposed

## Prerequisites
- Schema: `public.bookings` with `check_in DATE`, `check_out DATE`, `status` in ('confirmed','pending','checked-in','checked-out'), `cancelled BOOLEAN` (see `database.sql`).
- Index: `bookings(check_in, check_out)` present (see `comprehensive_rls_policies_migration.sql`).
- UI shells exist: `src/components/EnhancedKPIDashboard.tsx`, `src/components/MobileQuickStats.tsx`, `src/components/BookingManagement.tsx`, optional `src/components/BookingDetails.tsx`.
- RLS: Views will respect underlying table RLS; no special bypass required.

## Story
As Front Desk staff, I need unmissable alerts showing all bookings that need action today (check-ins not yet checked in/cancelled and check-outs not yet checked out/extended), so I can resolve each case manually. The system must not mutate records automatically; it should only surface violations prominently and provide one-click actions to resolve.

## Acceptance Criteria
- View `public.booking_enforcement_violations_today` exists and returns rows that match exactly these rules:
  - Check-in violation: `check_in = current_date` AND `cancelled = false` AND `status NOT IN ('checked-in','checked-out')`.
  - Check-out violation: `check_out = current_date` AND `cancelled = false` AND `status <> 'checked-out'`.
  - Returns columns: `id, property_id, room_no, guest_name, check_in, check_out, status, cancelled, violation_type` where `violation_type` is `'check-in-violation'` or `'check-out-violation'`.
- Dashboard banner (in `EnhancedKPIDashboard.tsx`) shows an "Action required" strip whenever today counts > 0 with copy like: `X check-ins pending • Y check-outs pending` and a "Review now" CTA.
- Mobile quick view (in `MobileQuickStats.tsx`) shows two compact counters for today's pending check-ins and check-outs.
- Booking Management (in `BookingManagement.tsx`) adds a preset filter/tab "Today’s Actions" that lists only the violations from the view, with a visible badge per row (`violation_type`).
- Row-level CTAs:
  - For `check-in-violation`: [Mark Checked-In] and [Cancel].
  - For `check-out-violation`: [Check-Out] and [Extend].
- Taking any CTA updates the booking through existing flows/services; the row disappears from the list immediately after success.
- No automation: the system does not auto-cancel, auto-check-out, or auto-extend.

## Non-Goals
- No scheduled jobs/cron/Edge Functions.
- No push notifications (Telegram, email). Pull-based only via UI.

## Tasks
- SQL
  - Create view `public.booking_enforcement_violations_today` matching the logic above.
  - Optional consistency: `ALTER TABLE public.bookings ADD CONSTRAINT chk_cancelled_status CHECK (NOT cancelled OR status NOT IN ('checked-in','checked-out'));`
- Service
  - Add `src/services/bookingComplianceService.ts` with:
    - `getTodayCounts(propertyId?: string)` → `{ pendingCheckIns: number, pendingCheckOuts: number }`.
    - `getTodayViolations(propertyId?: string)` → array of rows from the view.
- UI
  - `EnhancedKPIDashboard.tsx`: show banner when counts > 0; CTA deep-links to Booking Management with preset filter.
  - `MobileQuickStats.tsx`: show two badges for today counts with on-press deep-link.
  - `BookingManagement.tsx`: add "Today’s Actions" preset; render violation badges; provide the four CTAs using existing booking services.
  - Optional `BookingDetails.tsx`: show a slim inline notice when the open booking matches a violation.
- Access & Performance
  - Ensure queries include `property_id` filter when a property is selected.
  - Verify index utilization and fast response (<150ms typical).

## Dev Notes
- Suggested SQL for the view (reference):
  ```sql
  CREATE OR REPLACE VIEW public.booking_enforcement_violations_today AS
  SELECT 
    b.id,
    b.property_id,
    b.room_no,
    b.guest_name,
    b.check_in,
    b.check_out,
    b.status,
    b.cancelled,
    CASE 
      WHEN b.check_in = current_date AND NOT b.cancelled AND b.status NOT IN ('checked-in','checked-out')
        THEN 'check-in-violation'
      WHEN b.check_out = current_date AND NOT b.cancelled AND b.status <> 'checked-out'
        THEN 'check-out-violation'
    END AS violation_type
  FROM public.bookings b
  WHERE (b.check_in = current_date AND NOT b.cancelled AND b.status NOT IN ('checked-in','checked-out'))
     OR (b.check_out = current_date AND NOT b.cancelled AND b.status <> 'checked-out');
  ```
- Deep-linking: store preset in URL (e.g., `?preset=today-actions&property=<id>`), so banner and mobile counters can link consistently.
- Keep the view read-only; all mutations go via existing booking services.

## Testing
- Unit: service functions return correct counts for seeded data.
- Integration: view logic correctness around edge cases (already checked-out at 00:01, cancelled during the day, etc.).
- UI manual:
  - With seeded violations, banner and counters appear.
  - "Review now" opens filtered list; taking a CTA updates booking and removes the row.
  - Switching property filters updates counts and list.

## Change Log
- 2025-08-26: Initial story drafted (alerts-based enforcement for today).
