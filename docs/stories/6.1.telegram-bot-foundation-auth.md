# Status
Completed

# Story: Telegram Bot - Foundation & Auth (grammY on Supabase Edge)
Set up a lightweight Telegram bot as a Supabase Edge Function using grammY, with a simple whitelist-based auth (authorized Telegram user IDs). Provide a narrow set of essential commands scaffolded for quick mobile operations.

## Prerequisites
- Review `docs/implementation-plans/telegram-bot-implementation-plan.md`.
- Supabase project is configured (see `docs/stories/5.1.supabase-auth-configuration-setup.md`, `5.2.row-level-security-policies-implementation.md`, `5.3.dual-supabase-client-configuration.md`).

## Acceptance Criteria
- Authorized-only access using hardcoded Telegram user IDs in the bot function.
- Edge Function created at `supabase/functions/telegram-bot/index.ts` and deployable locally and to Supabase.
- Webhook handler correctly responds to Telegram `POST` updates.
- `/start` shows a concise help menu of available commands.
- Configuration uses environment variables for Telegram bot token and optional default property ID.
- Minimal rate limiting guard for safety (simple in-function time window throttle).
 - Timezone policy is configurable via `BOT_TIMEZONE` (default `Asia/Kolkata`), used by date-based commands (e.g., `/today`, `/report`).

## Tasks
- Create Edge Function skeleton
  - Path: `supabase/functions/telegram-bot/index.ts`
  - Initialize grammY Bot with `Deno.env.get('TELEGRAM_BOT_TOKEN')`.
  - Implement whitelist middleware for `AUTHORIZED_TELEGRAM_USER_IDS` (array of IDs).
  - Implement `/start` with a minimal help text (list commands and brief usage).
- Config & metadata
  - Path: `supabase/functions/deno.json`
  - Add permissions and imports if needed for grammY.
  - Document environment variables in `/.env.example` (for Vite app only, and note Supabase functions use project env). Include `TELEGRAM_BOT_TOKEN`, `BOT_DEFAULT_PROPERTY_ID`, and `BOT_TIMEZONE` (default `Asia/Kolkata`) in docs, not `.env.example` values.
- Dev bootstrap
  - Add local run instructions in story Dev Notes.
  - Ensure function export handler matches Supabase Edge Function signature.

## Dev Notes
- Use grammY Deno import:
  - Example (version pin recommended):
    ```ts
    import { Bot, webhookCallback } from "https://deno.land/x/grammy@v1.24.1/mod.ts";
    ```
- Supabase function handler:
  ```ts
  const bot = new Bot(Deno.env.get("TELEGRAM_BOT_TOKEN") ?? "");

  const AUTHORIZED_TELEGRAM_USER_IDS = [123456789, 987654321]; // TODO: update

  bot.use(async (ctx, next) => {
    const uid = ctx.from?.id;
    if (!uid || !AUTHORIZED_TELEGRAM_USER_IDS.includes(uid)) {
      await ctx.reply("â›” Unauthorized access. Contact admin.");
      return;
    }
    await next();
  });

  bot.command("start", async (ctx) => {
    await ctx.reply(
      [
        "Welcome ðŸ‘‹",
        "Commands:",
        "/switch - choose property",
        "/today - check-ins/check-outs/dues",
        "/book - quick booking",
        "/expense - capture expense",
        "/report - quick KPIs",
      ].join("\n")
    );
  });

  const handleUpdate = webhookCallback(bot, "std/http");

  Deno.serve(async (req) => {
    if (req.method === "POST") return handleUpdate(req);
    return new Response("OK", { status: 200 });
  });
  ```
- Rate limiting: maintain in-memory map of last request timestamp by `from.id` with a short window (e.g., 500ms) to drop accidental double taps.
 - Timezone: use `Deno.env.get("BOT_TIMEZONE") ?? "Asia/Kolkata"` when deriving "today" or month windows in commands.

## Testing
- Local:
  - `supabase functions serve telegram-bot` and forward Telegram webhook using `ngrok` or Supabase CLI built-in.
  - Verify `/start` works and unauthorized users receive rejection.
- Cloud:
  - Deploy function and set Telegram webhook to the Deployed URL.

## Change Log
- 2025-08-20: Marked Completed. Implemented Edge Function at `supabase/functions/telegram-bot/index.ts`, deployed with `--no-verify-jwt`, configured secrets (TELEGRAM_BOT_TOKEN, AUTHORIZED_TELEGRAM_USER_IDS, BOT_TIMEZONE), and set Telegram webhook to the deployed URL. `/start` shows commands and IST date.
- 2025-08-21: Initial story draft created.
