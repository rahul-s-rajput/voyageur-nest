# Story 6.3a — Telegram Bot: Bookings Modify Flow + Adults/Children Capture

Status: Planned

## Prerequisites
- Supabase tables
  - bookings: has no_of_pax integer, adult_child text (e.g., "2/1"), room_no, check_in, check_out, property_id, status, cancelled, total_amount, special_requests, etc.
  - rooms: has max_occupancy integer, unique (property_id, room_number)
- Supabase Edge Function (Deno) using grammY in `supabase/functions/telegram-bot/index.ts`
- RLS: service-role key used by Edge Function; server-side updates permitted

## Acceptance Criteria
- Modify button on a booking opens a Modify menu with options:
  - Dates, Room, Guest name, Adults, Children, Amount, Notes, Back to Summary, Cancel
- Dates change flow uses calendar(s), validates conflicts; if conflict, offer room change
- Room change flow lists only available rooms for the date range
- Adults/Children can be changed with inline numeric pickers, validated against rooms.max_occupancy
- /book wizard captures Adults and Children, persists no_of_pax and adult_child
- Booking summaries show guest counts (pax and breakdown) in /booking detail views
- Inline keyboards are valid (no extra nesting), and back navigation is provided everywhere
- End-to-end tests pass for create, modify, and cancel flows

## Tasks
- Wizard enhancements (/book)
  - Add steps: adults -> children before amount
  - Validate against `rooms.max_occupancy`
  - Insert `no_of_pax = adults + children`, `adult_child = "A/C"`
  - Show pax summary in confirm screen
- Modify flow (/booking)
  - Implement `bk:modify:<id>` menu and sub-flows
  - Dates: calendars -> validate room availability -> update booking (or choose other room)
  - Room: list available rooms for current dates -> update `room_no`
  - Guest: prompt text -> update `guest_name`
  - Adults/Children: numeric pickers -> validate capacity -> update `no_of_pax`, `adult_child`
  - Amount: prompt numeric -> update `total_amount`
  - Notes (optional): prompt text -> update `special_requests`
  - Provide Back to Modify and Back to Summary buttons
- Summaries
  - `formatBookingSummary()` adds: `Guests: <no_of_pax> (<A>/<C>)`
- Helpers
  - `loadBooking(id)`, `parseAdultChild(str)`, `composeAdultChild(a,c)`
  - Capacity lookup for `(property_id, room_number)`
- Validation
  - Overlap logic for dates: `(check_in < new_checkOut) AND (check_out > new_checkIn)`
  - Capacity: `adults >= 1`, `children >= 0`, `adults + children <= max_occupancy`
- UX
  - Consistent back buttons; avoid nested arrays in inline keyboards
  - Answer callback queries safely (try/catch)
- Testing
  - /book with pax -> persisted values
  - /booking search → summary shows pax
  - Modify dates (conflict and non-conflict), room, pax, amount, guest name
  - Cancel booking
- Deployment
  - Deploy updated `supabase/functions/telegram-bot`
  - Re-test commands and inline flows

## Dev Notes
- IDE TypeScript lint errors about Deno imports are expected locally; runtime in Supabase Edge Functions is Deno
- Keep callback namespace tidy:
  - Modify menu: `bk:modify:<id>`
  - Back to summary: `bk:show:<id>`
  - Dates: `mod_checkin:<id>:...`, `mod_checkout:<id>:...`, finalize `bk:set_dates:<id>:<ci>:<co>`
  - Room: `bk:modify_room:<id>`, `bk:set_room:<id>:<roomNo>`
  - Guest: `bk:modify_guest:<id>` then text input
  - Adults: `bk:modify_adults:<id>`, `bk:set_adults:<id>:<n>`
  - Children: `bk:modify_children:<id>`, `bk:set_children:<id>:<n>`
  - Amount: `bk:modify_amount:<id>` then text input
  - Notes: `bk:modify_notes:<id>` then text input

## Testing
- Create booking via /book with adults=2, children=1 → `no_of_pax=3`, `adult_child='2/1'`
- Capacity checks with small `max_occupancy` rooms
- /booking search by name/date/recent → detail shows pax
- Modify flows:
  - Change pax within capacity
  - Change amount and guest name
  - Change dates to conflict → prompt to choose different room or dates
  - Change room to available one
- Regression: property switch, start/ping, keyboard rendering

## Change Log
- 2025-08-21: Initial plan drafted and saved
