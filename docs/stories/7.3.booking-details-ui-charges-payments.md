# Status
Complete — Implemented and verified on 2025-08-24

# Story: Booking Details UI — Charges & Payments
Enhance `src/components/BookingDetails.tsx` to manage charges and payments with summaries.

## Prerequisites
- Services available (`7.2`).

## Acceptance Criteria
- Charges: A Charges section exists with Food typeahead and Misc entry; supports edit and soft-void actions using `bookingChargesService.createFoodCharge/createMiscCharge/update/void`.
- Payments: A Payments section exists with Add Payment and Add Refund; supports soft-void via `bookingPaymentsService.addPayment/addRefund/void`.
- Summary: A summary panel reads from `public.booking_financials` for `charges_total`, `discounts_total`, `taxes_total`, `gross_total`, `payments_total`, `refunds_total`, `balance_due`, `status_derived`, and `last_activity_at`. Summary refreshes after mutations.
- Scope: All operations are property-scoped using `useCurrentPropertyId()` and respect RLS.
- Typeahead: Food search uses `menuService.listItems({ propertyId, search, availableOnly: true, locale })` with localized names when available.
- Legacy: Legacy booking payment fields remain read-only; the authoritative balance comes from `booking_financials`.
- UX: Responsive UI with modals and collapsible sections; optimistic updates with rollback on error; toasts for success/error.

## Tasks
- Add UI panels and modals for add/edit flows (charges, payments). Use Radix Dialog `onOpenChange={(open) => { if (!open) handleClose(); }}`.
- Integrate Food typeahead using `menuService.listItems` with `availableOnly=true` and current `locale`.
- Wire Charges CRUD to `bookingChargesService` and Payments CRUD to `bookingPaymentsService` using `propertyId` from `useCurrentPropertyId()`.
- Fetch and render `booking_financials` row for the booking; refresh the summary after each mutation (or when `last_activity_at` changes).
- Implement optimistic updates with rollback on failure; ensure numeric fields are treated as numbers in state.
- Input validation: enforce `quantity > 0`, `unitAmount >= 0`, `amount > 0` before calling services; show error toasts.
- Distinct styling for `charge_type = 'discount'` rows; do not implement per-line discount fields.
- Leave legacy payment fields read-only; remove any edit affordances in this view.

## Dev Notes
- Keep UI lean; avoid clutter by using modals and collapsible sections.
- Optimistic updates: update local lists immediately; on error, rollback local state and toast the error.
- Property scope: use `useCurrentPropertyId()` from `src/contexts/PropertyContext.tsx` for all service calls.
- Supabase client: import unified client via `src/lib/supabase/index` (services already do this); do not instantiate new clients.
- Discounts are separate charge rows (`charge_type = 'discount'`); render with distinct/negative styling. No per-line discount fields.
- Summary refresh: use `booking_financials.last_activity_at` as a heuristic to refresh aggregates after mutations.
- Out of scope: creating `adjustment` payments via UI (service supports type but UI will only add `payment` and `refund`).

## Testing
- Charges: add Food via typeahead and Misc manually; edit quantity/unit; void a charge; verify list updates and summary reflects changes.
- Payments: add Payment and Refund; void a payment/refund; verify list updates and summary reflects changes.
- Summary: after each mutation, confirm `booking_financials` values and derived status update. Balance shown equals `balance_due`.
- Legacy fields: verify they are displayed but not editable.
- Print invoice preview to confirm totals match the summary.
- DB manual tests: use `set_config('request.jwt.claims', ...)` from `7.1` to simulate property scope.

## Verification Summary
- __Charges__: `BookingDetails.tsx` uses `bookingChargesService.createFoodCharge/createMiscCharge/update/void`; optimistic list updates with rollback on error and success/error toasts; supports backdated `createdAt` on create.
- __Payments__: `bookingPaymentsService.addPayment/addRefund/void` wired with optimistic updates, toasts, and optional `createdAt` for backdating.
- __Summary__: Reads from `booking_financials` via `bookingFinancialsService.getByBooking()` and displays `chargesTotal`, `discountsTotal`, `taxesTotal`, `grossTotal`, `paymentsTotal`, `refundsTotal`, `balanceDue`, `statusDerived`, `lastActivityAt`. Calls `reloadFinancials()` after mutations.
- __Typeahead__: Food search calls `menuService.listItems({ propertyId, search, availableOnly: true, locale: currentLanguage })` for localized names.
- __Scope__: All service calls use `useCurrentPropertyId()` ensuring property scoping.
- __Legacy__: Legacy payment fields are not editable; UI shows a single authoritative financial summary derived from `booking_financials` and `booking_payments`.

## Change Log
- 2025-08-22: Story drafted.
- 2025-08-23: Refined after backend/services review. Clarified acceptance criteria, added `booking_financials` integration, property scope via context, optimistic updates, Radix Dialog handler pattern, and testing specifics. Ready for implementation.
- 2025-08-24: Implemented and verified in `BookingDetails.tsx`; status updated to Complete; added verification summary.
