# Status
Completed

# Story: Booking Charges & Payments — Schema and RLS
Create normalized tables for booking charges and payments, derived totals view, and property-scoped RLS policies.

## Prerequisites
- Review current schema in `database.sql` and menu schema in `menu_management_migration.sql`.
- Supabase project with RLS patterns used by `expenses` and `menu_items`.

## Acceptance Criteria
- Tables `booking_charges` and `booking_payments` created with columns and constraints as per plan.
- `booking_financials` view created with aggregates: charges_total, discounts_total, taxes_total, gross_total, payments_total, refunds_total, balance_due, status_derived.
- RLS policies enforce property-scoped access for select/insert/update/delete on both tables.
- Updated `updated_at` triggers exist on both tables.

## Tasks
- Write migration `migrations/booking_charges_payments_migration.sql` to:
  - Create `booking_charges`, `booking_payments`.
  - Create indexes and `updated_at` triggers.
  - Add RLS policies aligned to property scope.
  - Create `booking_financials` view (with effective per-line discounts).
- Document how to apply the migration.  
  Status: Completed — schema, RLS, triggers, indexes, view, consistency triggers, tests (aggregates & RLS), and documentation are done. See "How to Apply" below for reference.

## How to Apply
1. Run the primary migration in your Supabase SQL Editor or psql:
   - `migrations/booking_charges_payments_migration.sql`
   - This creates tables, RLS, triggers, indexes, and the `booking_financials` view.
2. Run the small follow-up to align the view column name with this story (status_derived):
   - `migrations/booking_financials_view_status_alias_fix.sql`
3. Notes:
   - The migration ensures `pgcrypto` is available for `gen_random_uuid()`.
   - View privileges are restricted to `authenticated`.

## Dev Notes
- Use `numeric(10,2)` and `numeric(12,2)` for monetary precision.
- Keep compatibility with `bookings.payment_amount`/`payment_mode` (deprecated for UI editing).
- Consider partial indexes for NOT is_voided.

## Valid types
- `booking_charges.charge_type`: `room`, `fnb`, `misc`, `discount`, `tax`, `service_fee`
- `booking_payments.payment_type`: `payment`, `refund`, `adjustment`

## Testing
- Apply both migrations locally.
- Validate aggregates on the view with sample data (discounts and refunds cases). Example:

```sql
-- Positive case: matching property scope (rows visible, writes allowed)
-- Set property scope for RLS (Option A: via JWT claims)
select set_config(
  'request.jwt.claims',
  json_build_object('role','authenticated','property_id','<property-uuid>')::text,
  true
);

-- If the above is not allowed in your environment, use the fallback (Option B):
-- select set_config('request.property_id', '<property-uuid>', true);

-- Insert sample charges
insert into public.booking_charges (property_id, booking_id, charge_type, description, quantity, unit_amount, amount)
values
('<property-uuid>', '<booking-uuid>', 'room', 'Room Night', 2, 1500, 3000),
('<property-uuid>', '<booking-uuid>', 'tax', 'GST', 1, 540, 540),
('<property-uuid>', '<booking-uuid>', 'discount', 'Promo', 1, 200, 200);

-- Insert payments/refunds
insert into public.booking_payments (property_id, booking_id, payment_type, method, amount)
values
('<property-uuid>', '<booking-uuid>', 'payment', 'upi', 2000),
('<property-uuid>', '<booking-uuid>', 'refund', 'upi', 100);

-- Validate aggregates
select * from public.booking_financials where booking_id = '<booking-uuid>';

### RLS tests
- Positive: property matches → can see rows and write
- Negative: different property → SELECT returns 0 rows; INSERT denied by RLS

```sql
BEGIN;
SET ROLE authenticated;

-- Scope to a different property (no access expected)
SELECT set_config(
  'request.jwt.claims',
  json_build_object('role','authenticated','property_id','<different-property-uuid>')::text,
  true
);

-- Expect 0 rows
SELECT * FROM public.booking_charges
WHERE booking_id = '<booking-uuid>';

-- Expect RLS error
INSERT INTO public.booking_payments (property_id, booking_id, payment_type, amount)
VALUES ('<property-uuid>', '<booking-uuid>', 'payment', 1);

COMMIT;
```

## Change Log
- 2025-08-22: Story drafted.
