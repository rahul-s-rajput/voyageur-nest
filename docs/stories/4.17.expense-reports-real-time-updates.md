# Story 4.17: Real-time Updates & Auto-refresh

## Status
Ready for Review

## Story
As a property manager,
I want the dashboard to update automatically,
So that I always see current data without manual refresh.

## Acceptance Criteria
1. Auto-refresh every 30 seconds (configurable per user/property)
2. Visual indicator when new data arrives (badge/pulse + tooltip time)
3. Smooth, diff-based updates without page flicker
4. Pause/resume auto-refresh and "Refresh now" action
5. WebSocket support for instant updates with polling fallback
6. Offline detection; resume sync on reconnect
7. Dark-mode friendly indicators and a11y announcements

## Tasks / Subtasks
- [ ] Implement `useRealtimeExpenses` hook (polling + WebSocket)
  - [ ] Options: `intervalMs`, `paused`, `strategy: 'ws'|'poll'|'auto'`
  - [ ] Expose: `lastUpdated`, `isLive`, `hasNewData`, `error`
- [ ] WebSocket integration (Supabase Realtime channels)
  - [ ] Expenses, approvals, budgets channels
  - [ ] Auth/session handling, reconnect with backoff
- [ ] `LiveConfigContext` to manage refresh settings globally
- [ ] `LiveUpdateIndicator` component (with screen reader announcements)
- [ ] Optimistic UI for small diffs; list/chart diff animations
- [ ] Network-aware intervals (reduce frequency on battery saver)
- [ ] Persist per-user/per-property settings to storage

## Dev Notes
- Reference: `docs/implementation-plans/expense-reports-ui-improvement-plan.md` (Real-time)
- Suggested locations:
  - `src/hooks/useRealtimeExpenses.ts`
  - `src/contexts/LiveConfigContext.tsx`
  - `src/components/Reports/LiveUpdateIndicator.tsx`
- Analytics: log refresh source (ws/poll), latency, error rate
- Performance targets: apply updates <100ms; 0 dropped frames

## Testing
- [ ] Auto-refresh triggers at interval and respects Pause
- [ ] WebSocket updates arrive instantly; fallback to polling on failure
- [ ] No flicker; diffs animate smoothly in tables/charts
- [ ] Offline/online transitions work with backoff/retry
- [ ] Battery/network impact minimal on mobile
- [ ] A11y: screen reader announces "Data updated at <time>"

## Success Metrics
- Freshness lag: <2s for WebSocket, <30s for polling
- Lost updates: 0 during reconnect scenarios
- Smoothness: >95% updates without visible flicker

## Integration Points
- Expense approval events update KPIs immediately
- Budget threshold alerts trigger live indicators
- Anomaly detection pushes real-time flags to UI

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation | Team |
