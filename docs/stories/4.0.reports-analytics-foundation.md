# Story 4.0: Reports & Analytics Foundation

## Status
Ready for Development

## Priority
CRITICAL - Must be completed before Stories 4.5-4.25

## Story
As a development team,
I want to establish a clean, scalable foundation for the new Reports & Analytics section,
So that we can build all reporting features (4.5-4.25) on solid architecture without legacy constraints.

## Context
Creating a brand-new Reports & Analytics hub separate from the existing Expense Management reports tab. This provides clean architecture, better UX, and risk-free migration path.

## Acceptance Criteria

### 1. Project Structure
- [ ] New directory structure created under `src/pages/PropertyManagement/ReportsAnalytics/`
- [ ] Component folders organized by feature (charts/, filters/, mobile/, overlays/, export/)
- [ ] Hooks, services, and contexts directories established
- [ ] TypeScript interfaces defined for all data models
- [ ] No dependencies on old ExpenseManagement components

### 2. Navigation & Routing
- [ ] New route `/property/reports-analytics` configured
- [ ] Navigation entry points in PropertyManagement dashboard
- [ ] Sub-routes for different report types (expenses, revenue, occupancy)
- [ ] Breadcrumb navigation implemented
- [ ] Deep linking support for specific reports/filters

### 3. Core Infrastructure
- [ ] React Query (TanStack Query) setup with QueryClient
- [ ] TanStack Table configured for data grids
- [ ] Zustand store for report state management
- [ ] Context providers (Theme, LiveConfig, Reports)
- [ ] Error boundaries for each major section

### 4. Data Layer
- [ ] ReportsService with clean API methods
- [ ] Data fetching hooks with proper caching
- [ ] Optimistic updates configured
- [ ] Background refetch strategies
- [ ] Proper TypeScript types for all API responses

### 5. Base Layout
- [ ] Responsive shell with header, sidebar, content area
- [ ] Tab navigation for report types
- [ ] Loading skeletons for all sections
- [ ] Empty states with helpful messages
- [ ] Mobile-responsive from day one

### 6. Authentication & Permissions
- [ ] Role-based access control (admin, manager, viewer)
- [ ] Property context switching
- [ ] Multi-property data isolation
- [ ] Secure API calls with proper headers

### 7. Performance Foundation
- [ ] Code splitting by route
- [ ] Lazy loading for heavy components
- [ ] Bundle analyzer configured
- [ ] Performance monitoring setup
- [ ] Initial bundle <100KB

### 8. Developer Experience
- [ ] Storybook stories for base components
- [ ] Unit test setup with React Testing Library
- [ ] ESLint rules for new section
- [ ] Documentation templates
- [ ] Mock data generators

### 9. Guest House Specific Infrastructure
- [ ] Seasonal pattern detection (Peak/Moderate/Low)
- [ ] Property comparison framework (Old Manali vs Baror)
- [ ] Weather API integration setup
- [ ] Local events calendar service
- [ ] Manali market benchmarks data

### 10. Data Adapters
- [ ] ExpenseService adapter layer
- [ ] Legacy data transformation
- [ ] Multi-property aggregation logic
- [ ] Currency conversion utilities

## Tasks / Subtasks

### Phase 1: Structure & Setup
- [ ] Create directory structure
  ```
  src/
  ├── pages/PropertyManagement/ReportsAnalytics/
  │   ├── index.tsx                    # Main dashboard
  │   ├── ExpenseReports.tsx          # Expense analytics
  │   ├── RevenueReports.tsx          # Revenue analytics (future)
  │   ├── OccupancyReports.tsx        # Occupancy analytics (future)
  │   ├── CustomDashboard.tsx         # Dashboard builder
  │   └── layouts/
  │       ├── ReportsLayout.tsx       # Shared layout
  │       └── MobileLayout.tsx        # Mobile-specific
  ```

- [ ] Setup component library structure
  ```
  src/components/ReportsAnalytics/
  ├── charts/           # Chart components (4.5-4.6)
  ├── filters/          # Filter components (4.8)
  ├── mobile/           # Mobile components (4.7, 4.20)
  ├── overlays/         # Overlays (4.22-4.23)
  ├── export/           # Export components (4.13-4.14, 4.21)
  ├── shared/           # Shared components
  └── widgets/          # Dashboard widgets (4.12)
  ```

- [ ] Create service layer
  ```
  src/services/reports/
  ├── ReportsService.ts
  ├── WeatherService.ts    # For 4.22
  ├── EventService.ts      # For 4.23
  ├── ForecastService.ts   # For 4.11
  └── ExportService.ts     # For 4.13-4.14
  ```

### Phase 2: Core Implementation
- [ ] Install and configure dependencies
  ```json
  {
    "@tanstack/react-query": "^5.x",
    "@tanstack/react-table": "^8.x",
    "zustand": "^4.x",
    "react-intersection-observer": "^9.x",
    "framer-motion": "^11.x",
    "date-fns": "^3.x",
    "react-window": "^1.x"
  }
  ```

- [ ] Setup React Query
  ```typescript
  // src/lib/reports/queryClient.ts
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 5 * 60 * 1000,      // 5 minutes
        cacheTime: 10 * 60 * 1000,     // 10 minutes
        retry: 3,
        refetchOnWindowFocus: false,
      },
    },
  });
  ```

- [ ] Create base contexts
  ```typescript
  // src/contexts/reports/
  - ReportsContext.tsx       // Main context
  - ThemeContext.tsx         // Dark mode (4.18)
  - LiveConfigContext.tsx    // Real-time (4.17)
  - FilterContext.tsx        // Shared filters
  ```

- [ ] Setup Zustand store
  ```typescript
  // src/stores/reportsStore.ts
  interface ReportsStore {
    // Filters
    dateRange: [Date, Date];
    selectedProperties: string[];
    selectedCategories: string[];
    
    // View state
    viewMode: 'dashboard' | 'table' | 'custom';
    activeTab: string;
    
    // Real-time
    isLive: boolean;
    lastUpdate: Date;
    
    // Actions
    setFilters: (filters: Partial<FilterState>) => void;
    resetFilters: () => void;
  }
  ```

### Phase 3: Data Models & Types
- [ ] Define TypeScript interfaces
  ```typescript
  // src/types/reports.ts
  interface ReportsDashboard {
    id: string;
    name: string;
    type: 'expense' | 'revenue' | 'occupancy' | 'custom';
    widgets: Widget[];
    filters: FilterState;
    layout: LayoutConfig;
  }
  
  interface Widget {
    id: string;
    type: WidgetType;
    config: WidgetConfig;
    position: GridPosition;
    data: DataQuery;
  }
  
  interface FilterState {
    dateRange: [Date, Date];
    properties: string[];
    categories: string[];
    comparison?: ComparisonConfig;
    // ... more filters
  }
  ```

### Phase 4: Base Components
- [ ] Create shell components
  ```typescript
  // ReportsLayout.tsx
  - Header with property selector
  - Sidebar with navigation
  - Main content area
  - Footer with live indicators
  ```

- [ ] Loading states
  ```typescript
  // SkeletonLoaders.tsx
  - KPICardSkeleton
  - ChartSkeleton
  - TableSkeleton
  - FilterPanelSkeleton
  ```

- [ ] Error handling
  ```typescript
  // ErrorBoundary.tsx
  - Graceful error display
  - Retry mechanisms
  - Error reporting
  ```

### Phase 5: Integration Points
- [ ] Connect to existing services
  ```typescript
  // Integrate with:
  - ExpenseService (reuse data fetching)
  - PropertyContext (multi-property)
  - AuthContext (permissions)
  - Supabase (real-time)
  ```

- [ ] Setup API endpoints
  ```typescript
  // API routes needed:
  GET /api/reports/expenses
  GET /api/reports/kpis
  GET /api/reports/forecasts
  POST /api/reports/export
  // ... etc
  ```

### Phase 6: Mobile Foundation
- [ ] Mobile-first responsive design
- [ ] Touch gesture support setup
- [ ] PWA manifest configuration
- [ ] Service worker registration
- [ ] Viewport meta tags

### Phase 7: Performance Setup
- [ ] Configure code splitting
  ```typescript
  const ExpenseReports = lazy(() => import('./ExpenseReports'));
  const CustomDashboard = lazy(() => import('./CustomDashboard'));
  ```

- [ ] Setup performance monitoring
  ```typescript
  // Web Vitals tracking
  // Bundle size budgets
  // Runtime performance metrics
  ```

### Phase 8: Testing & Documentation
- [ ] Unit test setup
- [ ] E2E test scenarios
- [ ] Storybook stories
- [ ] API documentation
- [ ] Component documentation

## Technical Specifications

### Architecture Decisions
1. **State Management**: Zustand for local, React Query for server state
2. **Styling**: Tailwind CSS + Shadcn UI components
3. **Charts**: Recharts as primary, D3 for complex visualizations
4. **Tables**: TanStack Table for all data grids
5. **Real-time**: Supabase Realtime + WebSocket fallback
6. **Offline**: Service Worker + IndexedDB
7. **Exports**: Client-side generation for small, server for large

### Performance Targets
- Initial load: <2s on 3G
- TTI: <3s on 3G
- Bundle size: <100KB initial, <500KB total
- Runtime: 60fps scrolling, <100ms interactions

### Browser Support
- Chrome 90+
- Safari 14+
- Firefox 88+
- Edge 90+
- Mobile browsers (iOS Safari, Chrome Android)

## Dev Notes
- This story MUST be completed before any 4.5-4.25 implementation
- Use feature flags to hide section until ready
- Keep old expense reports working during development
- Document all architectural decisions in ADR format
- Regular performance audits during development

## Testing Checklist
- [ ] All routes accessible and render correctly
- [ ] Property switching works throughout
- [ ] Data fetches successfully with proper caching
- [ ] Mobile responsive at all breakpoints
- [ ] Loading states display correctly
- [ ] Error states handle gracefully
- [ ] Performance budgets met
- [ ] Accessibility audit passes

## Success Metrics
- Clean architecture with 0 dependencies on old code
- Performance: <2s load time achieved
- Developer velocity: 50% faster feature development
- Code quality: 90%+ test coverage
- Maintainability: Clear separation of concerns

## Migration Strategy
1. Build new section completely independent
2. Feature flag for gradual rollout
3. A/B test with select users
4. Gather feedback and iterate
5. Redirect old reports to new section
6. Remove old code after 30 days stable

## Rollback Plan
- Feature flag allows instant rollback
- Old expense reports remain functional
- No data migration required (same backend)
- User preferences preserved

## Dependencies
- No dependencies on other stories
- Blocks all stories 4.5-4.25
- Requires access to existing ExpenseService
- Needs property management context

## Risks & Mitigations
| Risk | Impact | Mitigation |
|------|--------|------------|
| Scope creep | High | Strict focus on foundation only |
| Performance regression | Medium | Continuous monitoring |
| Browser compatibility | Low | Progressive enhancement |
| Team coordination | Medium | Clear boundaries and interfaces |

## Resources Required
- 1 Senior Frontend Developer (40 hours)
- 1 UI/UX Review (8 hours)
- 1 QA Engineer (8 hours)
- Total: ~56 hours

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-25 | 1.0 | Initial story creation | Team |

---

## Appendix: File Structure

```
src/
├── pages/
│   └── PropertyManagement/
│       └── ReportsAnalytics/
│           ├── index.tsx
│           ├── ExpenseReports.tsx
│           ├── RevenueReports.tsx
│           ├── OccupancyReports.tsx
│           ├── CustomDashboard.tsx
│           └── layouts/
│               ├── ReportsLayout.tsx
│               └── MobileLayout.tsx
│
├── components/
│   └── ReportsAnalytics/
│       ├── charts/
│       ├── filters/
│       ├── mobile/
│       ├── overlays/
│       ├── export/
│       ├── shared/
│       └── widgets/
│
├── hooks/
│   └── reports/
│       ├── useReportsData.ts
│       ├── useFilters.ts
│       └── useExport.ts
│
├── services/
│   └── reports/
│       ├── ReportsService.ts
│       ├── WeatherService.ts
│       ├── EventService.ts
│       └── ForecastService.ts
│
├── stores/
│   └── reportsStore.ts
│
├── contexts/
│   └── reports/
│       ├── ReportsContext.tsx
│       ├── ThemeContext.tsx
│       └── LiveConfigContext.tsx
│
└── types/
    └── reports/
        ├── dashboard.ts
        ├── widgets.ts
        └── filters.ts
```

This foundation provides a clean, scalable base for implementing all features in stories 4.5-4.25 without any legacy constraints or technical debt.
