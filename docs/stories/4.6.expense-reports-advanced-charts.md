# Story 4.6: Expense Reports - Advanced Chart Components

## Status
Ready for Review

## Story
As a property manager,
I want richer visualizations (heatmap, sunburst, gauges, waterfall),
So that I can understand patterns, hierarchy, utilization, and expense flow at a glance.

## Acceptance Criteria
1. Heatmap Calendar
   - Calendar view with color intensity by amount
   - Click to see day details
   - Mobile swipe navigation
   - Seasonal pattern highlighting (Peak/Moderate/Low seasons)
   - Integration with booking calendar for correlation analysis
2. Sunburst Chart
   - Interactive hierarchical drill-down
   - Animated transitions
   - Touch-friendly on mobile
   - Category grouping by expense type and vendor
   - Export as image (PNG/SVG)
3. Budget Gauge Charts
   - Animated needle/progress
   - Color zones (safe: <60%, warning: 60-80%, danger: >80%)
   - Percentage display
   - Real-time updates with animation
   - Alert thresholds configurable per property
4. Waterfall Chart
   - Clear positive/negative bars
   - Running total line
   - Category labels
   - Monthly/quarterly breakdown options
   - Drill-down to transaction level
5. Dark Mode Support
   - All charts adapt to theme changes
   - Proper contrast ratios maintained
   - Print-friendly alternative styles

## Tasks / Subtasks
- [ ] Implement Expense Heatmap (react-calendar-heatmap + tooltip)
  - [ ] Add seasonal overlays and pattern detection
  - [ ] Integrate with booking occupancy data
  - [ ] Touch gestures for mobile (pinch-zoom, swipe)
- [ ] Implement Sunburst (D3 or Recharts with custom rendering)
  - [ ] Hierarchical data transformation
  - [ ] Smooth zoom animations (<300ms)
  - [ ] Breadcrumb navigation
- [ ] Implement Budget Gauge (Recharts pie-based gauge)
  - [ ] Configurable thresholds per property
  - [ ] WebSocket subscription for real-time updates
  - [ ] Alert animation when crossing thresholds
- [ ] Implement Waterfall (stacked series + running total)
  - [ ] Time period selector (daily/weekly/monthly)
  - [ ] Export to CSV/Excel functionality
- [ ] Add responsive wrappers and mobile interactions
- [ ] Implement dark mode variants for all charts
- [ ] Add print CSS for chart exports
- [ ] Create chart screenshot utility

## Dev Notes
- Reference: `docs/implementation-plans/expense-reports-ui-improvement-plan.md` (Phase 1 - Task 1.2)
- Component guide: `docs/implementation-plans/expense-reports-components-guide.md` → `ExpenseHeatmap`, `BudgetGauge`, `ResponsiveChartContainer`
- Suggested locations:
  - `src/components/Reports/ExpenseHeatmap.tsx`
  - `src/components/Reports/BudgetGauge.tsx`
  - `src/components/Reports/SunburstChart.tsx`
  - `src/components/Reports/WaterfallChart.tsx`
  - `src/components/Reports/ChartExport.tsx`
  - `src/hooks/useChartTheme.ts`
- Libraries:
  - react-calendar-heatmap (heatmap)
  - D3.js (sunburst, complex visualizations)
  - Recharts (gauges, waterfall)
  - html2canvas (chart export)
- Performance:
  - Chart render: <500ms
  - Animation frame rate: 60fps
  - Touch response: <100ms
- Guest House Context:
  - Seasonal patterns for Manali (Peak: May-Jun, Oct-Nov)
  - Expense correlation with occupancy rates
  - Weather impact visualization (heating/cooling costs)

## Testing
- [ ] Verify interactions (click, drill-down, tooltips) on desktop/mobile
- [ ] Visual: color scales, transitions, labels, running total
- [ ] Performance: render under 500ms with realistic data (1000+ transactions)
- [ ] Print and dark-mode styles verified
- [ ] Real-time updates: gauge animations smooth
- [ ] Seasonal patterns correctly highlighted
- [ ] Export functions: PNG, SVG, PDF work correctly
- [ ] Touch gestures: pinch-zoom, swipe work on mobile
- [ ] Accessibility: keyboard navigation, screen reader descriptions
- [ ] Cross-browser: Chrome, Firefox, Safari, Edge
- [ ] Memory: no leaks with real-time updates

## Success Metrics
- Chart load time: <500ms
- User engagement: >70% interact with charts
- Export usage: >30% of users export charts
- Mobile interaction success: >90%

## Integration Points
- Booking calendar: Overlay occupancy on expense heatmap
- Weather API: Correlate utility expenses with temperature
  - Multi-property: Compare charts across properties
  - Budget system: Real-time gauge updates from budget changes

## Dependencies
- 4.17: Real-time Updates & Auto-refresh — live gauge/heatmap updates and animation triggers
- 4.18: Dark Mode & Print Support — theme tokens and print styles for all charts
- 4.19: PWA & Offline Support — offline caching/background sync of chart datasets
- 4.20: Mobile UI Enhancements — gestures and mobile containers for charts
- 4.21: Chart Export & Sharing — PNG capture and share flows for charts
- 4.22/4.23: Weather & Local Events Correlation — optional overlays/context for heatmap correlations
- 4.25: React Query + TanStack Table — standardized data fetching/caching for chart data
- 4.24: Mobile Push Notifications — threshold alerts for gauges (optional)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation | Team |
| 2025-08-16 | 1.1 | Added seasonal context, real-time, dark mode | Enhancement |
