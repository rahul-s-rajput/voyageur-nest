# Story 4.3: AI‑Powered OTA Email Parsing & Auto‑Import

## Status
- **Current Status**: Ready for Development
- **Priority**: High
- **Epic**: 4 - Multi-Property & OTA Management
- **Story Points**: 13
- **Assigned Dev Agent**: TBD
- **Sprint**: TBD

## User Story
**As a** property manager  
**I want** OTA booking emails to be automatically analyzed and imported using AI  
**So that** I never have to manually copy booking details from emails, regardless of format changes

## Business Context
Email is the primary system-of-record for many OTA booking notifications (Booking.com, MakeMyTrip/GoMMT, etc.). Manual re-entry is slow and error-prone. This story enables resilient ingestion of booking-related emails from Gmail, applies AI to extract structured booking data, and auto-imports or queues for human review based on confidence. It complements calendar sync and manual checklist flows by closing the gap for OTA providers that do not expose stable iCal/API formats, or whose templates change frequently.

## Scope
- In-scope: Gmail inbox monitoring for booking-related emails (Booking.com, MakeMyTrip/GoMMT to start), AI extraction, property detection, confidence scoring, auto-import path, manual review queue, notifications, and full audit trail.
- Out-of-scope: Direct OTA partner APIs; non-Gmail providers; training a bespoke model.

## Non‑Goals
- Building a general-purpose email client
- Parsing attachments beyond PDFs/HTML that come standard with OTA emails (advanced OCR is a future enhancement)

## Architecture Overview
- **Ingestion**: Gmail API monitors for new mail. Two modes supported:
  - Free‑friendly polling via `users.history.list` with `startHistoryId` incrementals and label filters.
  - Real-time push via Gmail `users.watch` → Cloud Pub/Sub topic → subscriber webhook.
- **Fetch & Filter**: Retrieve message metadata and body (minimal fields, partial response) only for messages under a configured `OTA` label.
- **Classification**: Lightweight header/heuristics + AI to determine booking relevance and classify event type: `new`, `modified`, `cancelled`, or `not_booking`.
- **AI Extraction**: Single AI call returns structured JSON aligned with our `OTABooking` superset schema, plus confidence and reasoning.
- **Property Resolution**: AI hint + deterministic mapping against known properties (by name, address, email aliases, phone) to a `property_id` (Old Manali or Baror). When confidence is low or multiple candidates match, default to the higher‑confidence match but require an override confirmation in the review UI.
- **Deduplication/Idempotency**: Message-level idempotency (`gmail_message_id`) and booking signatures (combination of OTA booking ID, guest name, stay dates) prevent duplicates.
- **Decisioning**: Confidence policy: >0.80 auto-import; 0.50–0.80 queued for review; <0.50 ignored (logged).
- **Import**: Create/Update/Cancel bookings via existing services; emit sync logs and notifications; attach audit trail with AI reasoning.
- **Room Assignment Strategy**: If the email only contains a room type (no room number), create the booking with `room_no = null`, store the `room_type`, and reserve inventory at the room‑type level. Front desk can assign an exact room number later without losing availability integrity.
- **Auditability**: Persist raw metadata, extracted JSON, confidence, reasoning, decision, and staff verification feedback for continuous improvement.

## Gmail Integration Design
- Gmail best practices: use label filters and partial responses; store `historyId` for incremental syncs; handle token invalidation via full sync fallback.
- Two ingestion modes:
  - **Polling (default, free-friendly)**: Schedule periodic incremental sync (e.g., every 1–5 minutes). Uses `users.history.list` to fetch changes since last `startHistoryId`.
  - **Push (advanced, near real-time)**: Configure `users.watch` to a Pub/Sub topic, subscriber invokes our ingestion endpoint; renew watches before expiration.
- Labeling strategy: Create Gmail filters to automatically apply label `OTA` (or `OTA/Booking`), matching known sender domains and subjects (e.g., `@booking.com`, `noreply@go-mmt.com`, ‘Booking confirmation’, ‘Reservation cancelled’), and optionally skip Inbox to reduce noise.

## Security & Trust Controls
- OAuth scope principle of least privilege (prefer `gmail.readonly` or `gmail.metadata` for discovery; only fetch full message for candidates).
- Sender allow-list and domain/DKIM checks. Flag suspicious links; never process payment links.
- Rate limiting and idempotent processing. Exclude SPAM/Promotions unless labeled `OTA`.
- PII minimization: store only fields required for booking creation and audit; redact payment details.

## AI Extraction Design
- **Model**: Default to Gemini 2.0 Flash‑Lite / 1.5 Flash (fast, low-cost); promote to higher‑tier if needed for complex cases.
- **Output**: Strict JSON schema (function/structured output) with:
  - `event_type`: `new` | `modified` | `cancelled` | `not_booking`
  - `ota_platform`: `booking_com` | `gommt` | `other`
  - `booking_reference`: string
  - `guest_name`: string
  - `contact_email`: string | null
  - `contact_phone`: string | null
  - `room_type`: string | null
  - `room_no`: string | null
  - `check_in`: ISO date
  - `check_out`: ISO date
  - `no_of_pax`: number | null
  - `adult_child`: string | null
  - `total_amount`: number | null
  - `currency`: string | null
  - `payment_status`: `paid` | `partial` | `unpaid` | null
  - `special_requests`: string | null
  - `property_hint`: string | null
  - `confidence`: 0..1
  - `reasoning`: string
  - `raw_fields`: Record<string, any> (for transparency)
- **Policies**:
  - Confidence thresholds control auto-import vs. manual review.
  - Enforce valid date ranges and sanity checks; on failures, downgrade to review with extraction issues noted.
  - Support room‑type‑only emails: when `room_no` is absent but `room_type` is present, proceed with import and mark booking as "Unassigned Room" until front desk assigns.
- **Explainability**: Persist `reasoning` for the staff review UI.

## Data Model Changes (proposed)
- `email_messages`
  - id (uuid)
  - gmail_message_id (string, unique)
  - thread_id (string)
  - label_ids (string[])
  - from, to, subject, received_at (timestamps)
  - snippet (string)
  - mime_parts (jsonb, optional minimal storage)
  - raw_source_ref (optional external storage pointer)
  - created_at, updated_at
- `email_ai_extractions`
  - id (uuid)
  - email_message_id (fk)
  - model (string)
  - output_json (jsonb)
  - confidence (float)
  - reasoning (text)
  - status: `auto_imported` | `needs_review` | `ignored`
  - created_at
- `email_booking_imports`
  - id (uuid)
  - email_message_id (fk)
  - extraction_id (fk)
  - property_id (fk)
  - event_type (`new`|`modified`|`cancelled`)
  - decision (`auto`|`manual-approved`|`manual-rejected`)
  - booking_id (fk, nullable)
  - import_errors (jsonb)
  - created_at, processed_at, processed_by
- Indexing: unique on `gmail_message_id`, composite keys on `(booking_reference, check_in, check_out)` for idempotency.

## Service & UI Integration (codebase alignment)
- New services in `src/services/`:
  - `gmailIngestionService.ts`: handle polling/push, history tokens, message fetch, labeling filters, sender allow-list.
  - `aiEmailParserService.ts`: call Gemini with structured schema, validate, normalize to `OTABooking` superset.
  - `emailBookingImportService.ts`: dedupe, property resolution (via `propertyService.ts`), call `roomBookingService.ts` to create/update/cancel, update `ota_sync_logs` via `otaMonitoringService.ts`.
- Extend monitoring in `OTAMonitoringService` to include email ingestion metrics (processed, auto-import rate, failure rate, average confidence).
- UI additions:
  - Add an “Email Imports” tab under `BookingManagement.tsx` with a review queue and detail panel showing AI reasoning, confidence, and extracted fields.
  - Add an "Email‑sourced bookings" dropdown in `BookingManagement.tsx` listing recent detected booking emails. From this dropdown, staff can: create new booking, modify existing booking, or execute cancellation; see detected property (Old Manali / Baror) with confidence chip and override selector; and perform a "Quick Assign Room" action to map a type‑held booking to a specific room when ready.
  - Surface notifications in `NotificationCenter.tsx` for auto-imports and review-required cases.

## Acceptance Criteria
- **Gmail Integration**
  - Polling mode processes new emails within 1–5 minutes; Push mode within seconds when enabled.
  - Label-filtered ingestion prevents non-OTA emails from being processed.
- **AI Classification & Extraction**
  - Correctly distinguishes booking vs. non-booking emails.
  - Outputs structured JSON aligned to schema with confidence and reasoning.
  - Detects `new`, `modified`, `cancelled` events reliably on supported providers.
- **Decision Policy**
  - >0.80 confidence auto-imports; 0.50–0.80 queues for manual review; <0.50 ignored (logged).
  - Auto-import path creates/updates/cancels bookings with correct property mapping.
- **Property Detection & Override**
  - System infers property (Old Manali vs Baror) from email content and known property catalog; when confidence <0.80, UI clearly shows both candidates and requires staff confirmation.
  - Staff can override the detected property before import without re-running AI.
- **Room Type Handling**
  - When only a room type is present, the system creates the booking with `room_no = null`, reserves inventory by room type, reflects this in availability, and allows later assignment.
  - "Quick Assign Room" updates the booking with a specific room and reconciles inventory correctly.
- **Verification UI**
  - Staff can review medium-confidence extractions, see reasoning, correct fields, and approve/reject.
  - Feedback is logged and reflected in audit trail.
- **Emails Dropdown**
  - Booking management shows an "Email‑sourced bookings" dropdown to quickly add/modify/cancel based on detected emails, with property chips and confidence indicators.
- **Notifications & Audit**
  - Real-time notifications on auto-import and review-required events.
  - Complete audit trail per message and import decision.

## Definition of Done
- Gmail polling working end-to-end with history tokens and idempotency.
- Optional Pub/Sub push path documented and tested.
- AI extraction achieves ≥98% accuracy on test corpus of supported OTA emails (measured against ground truth).
- Staff review interface functional with confidence/reasoning display and edit-before-import.
- Import operations update monitoring dashboards and audit tables.
- Security review complete (scopes, PII minimization, sender allow-list, redaction).

## Quotas & Cost Considerations
- Gmail per-method quotas are generous; use `history.list` for incrementals and partial fields to minimize units. See Gmail API usage limits and incremental sync guidance.  
  References: [Gmail watch](https://developers.google.com/workspace/gmail/api/reference/rest/v1/users/watch), [Synchronizing clients](https://developers.google.com/workspace/gmail/api/guides/sync), [users.history.list](https://developers.google.com/workspace/gmail/api/reference/rest/v1/users.history/list), [Usage limits](https://developers.google.com/workspace/gmail/api/reference/quota).
- Pub/Sub triggers are near real-time and scalable; minimal costs at our expected volume; quotas documented by Google Cloud.  
  Reference: [Pub/Sub quotas](https://cloud.google.com/pubsub/quotas).
- Gemini API models offer free tiers and low paid rates suitable for text extraction at scale. Prefer Flash‑Lite/Flash for low cost; upgrade selectively.  
  References: [Gemini pricing overview](https://gemini-api.apidog.io/doc-965864), community calculators for ballpark rates such as [InvertedStone](https://invertedstone.com/calculators/gemini-pricing).

## Risk Management
- **Template Drift**: OTA templates change → mitigated by AI extraction and schema validation; backup rule-based patterns for well-known providers.
- **Phishing/Scams**: Process only allow-listed sender domains and DKIM‑valid messages; never follow payment links; treat payment instructions as non-authoritative.
- **History Token Gaps**: Handle 404 on `startHistoryId` by full sync with backoff.
- **Duplicate/Looping**: Strong idempotency on `gmail_message_id` and booking signatures.

## Test Plan
- Unit tests: AI schema validation, normalization, date calculations, idempotency logic, property mapping.
- Integration tests: Simulate Gmail history sync with fixtures; verify end-to-end extraction and decisioning.
- UI tests: Review queue actions, edits, approve/reject flows.
- Accuracy evaluation: Curated corpus of Booking.com and GoMMT emails covering `new`/`modified`/`cancelled`.

## Rollout Plan
- Phase 1: Polling ingestion, Flash‑Lite extraction, review UI, auto‑import for high confidence.
- Phase 2: Optional Pub/Sub push for near real-time; add PDF/attachment parsing if needed.
- Phase 3: Feedback loop analytics; tune prompts and thresholds; expand to additional OTAs.

## Tasks / Subtasks
- **T1: Gmail Ingestion (Polling)**
  - [ ] Create Gmail OAuth credentials; configure `OTA` label and filters
  - [ ] Implement `gmailIngestionService` (history tokens, message fetch, label filtering, idempotency)
  - [ ] Store messages in `email_messages`; write fixtures for tests
- **T2: AI Extraction**
  - [ ] Implement `aiEmailParserService` with Gemini structured output and schema validation
  - [ ] Confidence thresholds and policy decisions
  - [ ] Store outputs in `email_ai_extractions`
- **T3: Import Pipeline**
  - [ ] Implement `emailBookingImportService` (dedupe, property resolution, call `roomBookingService`)
  - [ ] Support room‑type holds: import with `room_no = null`, reserve inventory by type, and expose API to finalize room assignment later
  - [ ] Persist decisions to `email_booking_imports`; emit monitoring logs
- **T4: UI & Notifications**
  - [ ] Add “Email Imports” review tab to `BookingManagement.tsx`
  - [ ] Add "Email‑sourced bookings" dropdown with actions (add/modify/cancel), property chip with override, and "Quick Assign Room"
  - [ ] Integrate with `NotificationCenter.tsx`
- **T5: Security & Monitoring**
  - [ ] Sender/domain allow-list and DKIM checks; PII redaction
  - [ ] Extend `otaMonitoringService` with email metrics
- **T6: Push Mode (Optional)**
  - [ ] Configure `users.watch` to Cloud Pub/Sub topic; implement subscriber webhook
  - [ ] Auto-renew watch; fallback to polling on failures

## Open Questions
- Should we store full raw email bodies, or minimal fields + secure blob storage pointer?
- Which OTA sender domains to include in the initial allow-list (per properties in use)?
- What SLAs are required for ingestion latency (polling interval vs. push)?
- How should we normalize OTA `room_type` strings to our internal room categories to ensure accurate type‑level holds and later room assignment?

## References
- Gmail API: [users.watch](https://developers.google.com/workspace/gmail/api/reference/rest/v1/users/watch), [Sync guide](https://developers.google.com/workspace/gmail/api/guides/sync), [users.history.list](https://developers.google.com/workspace/gmail/api/reference/rest/v1/users.history/list), [Usage limits](https://developers.google.com/workspace/gmail/api/reference/quota)
- Pub/Sub quotas: [Docs](https://cloud.google.com/pubsub/quotas)
- Gemini pricing: [Overview](https://gemini-api.apidog.io/doc-965864), [Community calculator](https://invertedstone.com/calculators/gemini-pricing) 