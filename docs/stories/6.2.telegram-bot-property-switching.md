# Status
Completed

# Story: Telegram Bot - Property Switching
Enable quick property selection using `/switch` with an inline keyboard of active properties. Default property can be set via environment (`BOT_DEFAULT_PROPERTY_ID`). Minimal persistence of last chosen property is optional.

## Prerequisites
- `6.1.telegram-bot-foundation-auth.md` completed.
- Active properties available via Supabase (see `src/lib/supabase/index.ts` and tables `properties`).

## Acceptance Criteria
- `/switch` lists active properties (`properties.is_active = true`) using inline keyboard.
- Selecting a property sets the current context for subsequent commands in the same chat.
- If `BOT_DEFAULT_PROPERTY_ID` is set, it is used initially when no selection is made.
- Optional: persist last selected property per Telegram user to a minimal table `bot_user_settings` with columns `(telegram_user_id bigint primary key, last_property_id uuid)`.

## Tasks
- Command & keyboard
  - Implement `/switch` in `supabase/functions/telegram-bot/index.ts`.
  - Fetch active properties with Supabase client (service role within function or RLS-allowed view).
  - Render inline keyboard; handle callback query to set selection.
- Context management
  - Maintain in-memory per-chat map `{chatId -> propertyId}` with fallback to default.
  - Optional persistence
    - Add migration: `migrations/add_bot_user_settings.sql`.
    - On selection, upsert `(telegram_user_id, last_property_id)`.
    - On chat start, load last property if record exists; else default.
- UX
  - Confirm selection via message: "Property set to: {name}".

## Dev Notes
- Properties fetch example:
  ```ts
  const { data: props } = await supabase
    .from("properties")
    .select("id,name")
    .eq("is_active", true)
    .order("name");
  ```
- Inline keyboard:
  ```ts
  const rows = (props ?? []).map(p => [{ text: p.name, callback_data: `prop:${p.id}` }]);
  await ctx.reply("Select property:", { reply_markup: { inline_keyboard: rows } });
  ```
- Callback handling:
  ```ts
  bot.on("callback_query:data", async (ctx) => {
    const data = ctx.callbackQuery.data ?? "";
    if (data.startsWith("prop:")) {
      const pid = data.slice(5);
      // set in-memory map; optional persist
      await ctx.answerCallbackQuery({ text: "Property updated" });
      await ctx.editMessageText(`Property set ✓`);
    }
  });
  ```

### Runtime config (secrets required)
- Set the following Supabase Function secrets before using `/switch`:
  - `SUPABASE_URL` (Project URL from Settings → API)
  - `SUPABASE_SERVICE_ROLE_KEY` (Service Role Key from Settings → API)
  - Optional: `BOT_DEFAULT_PROPERTY_ID` to preselect a property per chat

### Apply migration (optional persistence)
- Open Supabase Dashboard → SQL → New Query
- Paste contents of `migrations/add_bot_user_settings.sql`
- Run the script to create `public.bot_user_settings`
- Note: RLS disabled; function uses Service Role for access

## Testing
- `/switch` shows all active properties.
- Selecting a property updates context; subsequent `/today` uses that property.
- If optional table exists, restart function; bot restores last property.

## Change Log
- 2025-08-20: Completed. `/switch` implemented with inline keyboard and callback; added optional persistence via `public.bot_user_settings` (migration at `migrations/add_bot_user_settings.sql`). Edge Function loads last property on `/start` and upserts on selection.
- 2025-08-20: Implementation started. Added `/switch` command, inline keyboard, callback handling, and per-chat property context in `supabase/functions/telegram-bot/index.ts`.
- 2025-08-21: Initial story draft created.
