# Status
Planned

# Story: Telegram Bot â€” Add Charge and Payment Flows
Extend `supabase/functions/telegram-bot/features/booking.ts` to support creating and viewing booking charges and payments.

## Prerequisites
- Foundation and booking flows exist; property scope is available in context.
- Schema/services ready (`7.1`, `7.2`).

## Acceptance Criteria
- Booking summary shows totals and balance due.
- Inline actions: `âž• Add Charge`, `ðŸ’³ Add Payment`, `ðŸ§¾ View Charges`, `ðŸ’° View Payments`.
- Add Charge wizard: Food (typeahead menu items â†’ `charge_type = 'fnb'`) or Misc (free text â†’ `charge_type = 'misc'`), qty, unit price, confirmation, save. Discount is a separate action that creates a `discount` row (amount only).
- Add Payment wizard: amount, mode buttons (cash, upi, card, bank, other) â†’ set `method`, confirmation, save. Refunds are created with `payment_type = 'refund'`.
- View lists: last 5 charges/payments with pagination and `Void` actions (void sets `is_voided = true`).
- Summary pulls aggregates from `public.booking_financials` (charges_total, discounts_total, taxes_total, gross_total, payments_total, refunds_total, balance_due; show `status_derived`).
- View lists: last 5 charges/payments with pagination and `Void` actions.

## Tasks
- Define callback data scheme for new actions.
- Implement wizards using grammY conversation/wizard patterns.
- Query `menu_items` for Food typeahead (by `ilike` and `property_id`).
- Call services to create/void items; refresh summary after actions by re-reading booking totals from `booking_financials`.

## Dev Notes
- Keep messages concise and mobile-first.
- Add simple guardrails for repeated taps (rate limit already in foundation).
 - Map types strictly to allowed values: `fnb`, `misc`, `discount` for charges; payments use `payment`/`refund`/`adjustment`.
 - Set `method` to one of: `cash`, `upi`, `card`, `bank`, `other`.
 - Ensure property context is present for RLS (per 7.1). The DB trigger enforces that child `property_id` matches the booking; surface trigger errors to the user.

## Testing
- Manual E2E: happy-path adds, voiding, pagination.
- Negative: invalid booking, cross-property attempts.
 - Verify that creating a discount uses a separate `discount` row and that summary matches `booking_financials`.
 - Test that voiding sets `is_voided = true` and lines disappear from totals.

## Change Log
- 2025-08-22: Story drafted.
