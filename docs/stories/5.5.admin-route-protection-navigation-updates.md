# Story 5.5: Admin Route Protection & Navigation Updates

## Status
Ready for Development

## Story
**As a** developer  
**I want** to implement comprehensive admin route protection and update navigation components  
**So that** I can ensure secure access to admin features and provide intuitive navigation based on authentication state  

## Acceptance Criteria

### Route Protection Implementation
1. Admin routes are protected with authentication middleware
2. Unauthenticated users are redirected to sign-in page
3. Non-admin users are blocked from admin routes
4. Route protection works for both client-side and server-side navigation
5. Protected routes handle loading states appropriately
6. Route protection includes proper error handling
7. Nested admin routes are properly protected
8. Route guards work with React Router dynamic routing
9. Protected routes support query parameter preservation
10. Route protection includes audit logging

### Navigation Component Updates
11. Navigation shows different options based on authentication state
12. Admin navigation is only visible to authenticated admin users
13. Sign-in/sign-out buttons appear appropriately
14. Navigation includes user profile information when authenticated
15. Navigation handles authentication state changes smoothly
16. Navigation includes proper loading states
17. Navigation supports keyboard accessibility
18. Navigation includes responsive design for all devices
19. Navigation shows current route highlighting
20. Navigation includes proper ARIA labels and roles

### Protected Route Component Implementation
21. Protected route component is implemented for admin routes
22. Component validates session and user roles
23. Component handles expired sessions gracefully
24. Component includes proper error responses
25. Component supports both direct and nested routes
26. Component includes rate limiting for security
27. Component logs authentication attempts
28. Component handles CSRF protection
29. Component supports development debugging
30. Component includes performance optimizations

### Admin Layout Updates
31. Admin layout includes authentication-aware components
32. Layout shows user information and sign-out option
33. Layout includes navigation breadcrumbs
34. Layout handles authentication state changes
35. Layout includes proper error boundaries
36. Layout supports responsive design
37. Layout includes accessibility features
38. Layout shows loading states during authentication
39. Layout includes proper SEO meta tags
40. Layout supports theme customization

### Security & Performance
41. Route protection prevents unauthorized access
42. Authentication checks are performed efficiently
43. Navigation updates don't cause unnecessary re-renders
44. Protected routes include proper caching strategies
45. Security headers are properly configured
46. Route protection works with static generation
47. Authentication state is properly synchronized
48. Protected routes include proper error handling
49. Navigation includes proper security measures
50. Performance monitoring is implemented for route protection

## Tasks / Subtasks

- [ ] **Task 1: Authentication Middleware Implementation** (AC: 21-30)
  - [ ] Create `src/components/ProtectedRoute.tsx` with comprehensive authentication checks
  - [ ] Implement session validation and role checking
  - [ ] Add expired session handling and error responses
  - [ ] Include rate limiting and CSRF protection
  - [ ] Add authentication logging and debugging
  - [ ] Implement performance optimizations
  - [ ] Add support for both API and page routes
  - [ ] Include development debugging features

- [ ] **Task 2: Route Protection Components** (AC: 1-10)
  - [ ] Create `ProtectedRoute` component for admin routes
  - [ ] Implement authentication and role-based access control
  - [ ] Add loading states and error handling
  - [ ] Support nested routes and dynamic routing
  - [ ] Include query parameter preservation
  - [ ] Add audit logging for route access
  - [ ] Implement client-side and server-side protection
  - [ ] Add proper TypeScript types and interfaces

- [ ] **Task 3: Navigation Component Updates** (AC: 11-20)
  - [ ] Update main navigation to show authentication-aware options
  - [ ] Implement admin-only navigation sections
  - [ ] Add user profile display and sign-out functionality
  - [ ] Include authentication state change handling
  - [ ] Add loading states and accessibility features
  - [ ] Implement responsive design and keyboard navigation
  - [ ] Add current route highlighting and ARIA labels
  - [ ] Include proper error handling

- [ ] **Task 4: Admin Layout Implementation** (AC: 31-40)
  - [ ] Create comprehensive admin layout component
  - [ ] Include user information and navigation
  - [ ] Add breadcrumbs and authentication state handling
  - [ ] Implement error boundaries and responsive design
  - [ ] Add accessibility features and loading states
  - [ ] Include SEO optimization and theme support
  - [ ] Add proper component composition
  - [ ] Include performance optimizations

- [ ] **Task 5: Integration & Testing** (AC: 41-50)
  - [ ] Test route protection across all admin routes
  - [ ] Validate authentication middleware functionality
  - [ ] Test navigation updates and state synchronization
  - [ ] Validate security measures and performance
  - [ ] Test accessibility and responsive design
  - [ ] Ensure proper error handling and logging
  - [ ] Test static generation compatibility
  - [ ] Validate performance monitoring

## Dev Notes

### Authentication Middleware
```typescript
// src/middleware/auth.ts
import { NextRequest, NextResponse } from 'next/server'
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import type { Database } from '../lib/types/database.types'

// Rate limiting store (in production, use Redis or similar)
const rateLimitStore = new Map<string, { count: number; resetTime: number }>()

// CSRF token validation
function validateCSRFToken(request: NextRequest): boolean {
  const token = request.headers.get('x-csrf-token')
  const cookieToken = request.cookies.get('csrf-token')?.value
  
  return token === cookieToken
}

// Rate limiting
function checkRateLimit(ip: string, limit = 100, windowMs = 15 * 60 * 1000): boolean {
  const now = Date.now()
  const key = `${ip}:${Math.floor(now / windowMs)}`
  
  const current = rateLimitStore.get(key) || { count: 0, resetTime: now + windowMs }
  
  if (now > current.resetTime) {
    current.count = 0
    current.resetTime = now + windowMs
  }
  
  current.count++
  rateLimitStore.set(key, current)
  
  return current.count <= limit
}

// Audit logging
function logAuthAttempt(request: NextRequest, result: 'success' | 'failure' | 'blocked', reason?: string) {
  const log = {
    timestamp: new Date().toISOString(),
    ip: request.ip || 'unknown',
    userAgent: request.headers.get('user-agent') || 'unknown',
    path: request.nextUrl.pathname,
    result,
    reason
  }
  
  // In production, send to logging service
  console.log('Auth attempt:', log)
}

export async function middleware(request: NextRequest) {
  const response = NextResponse.next()
  const supabase = createMiddlewareClient<Database>({ req: request, res: response })
  
  // Get client IP for rate limiting
  const ip = request.ip || request.headers.get('x-forwarded-for') || 'unknown'
  
  // Check rate limit
  if (!checkRateLimit(ip)) {
    logAuthAttempt(request, 'blocked', 'Rate limit exceeded')
    return new NextResponse('Too Many Requests', { status: 429 })
  }
  
  // Skip auth for public routes
  const publicRoutes = ['/api/public', '/api/menu', '/api/rooms', '/api/bookings/create']
  const isPublicRoute = publicRoutes.some(route => request.nextUrl.pathname.startsWith(route))
  
  if (isPublicRoute) {
    return response
  }
  
  // Check if route requires authentication
  const adminRoutes = ['/admin', '/api/admin']
  const isAdminRoute = adminRoutes.some(route => request.nextUrl.pathname.startsWith(route))
  
  if (!isAdminRoute) {
    return response
  }
  
  try {
    // Get session
    const { data: { session }, error: sessionError } = await supabase.auth.getSession()
    
    if (sessionError) {
      console.error('Session error:', sessionError)
      logAuthAttempt(request, 'failure', 'Session error')
      return redirectToSignIn(request)
    }
    
    if (!session) {
      logAuthAttempt(request, 'failure', 'No session')
      return redirectToSignIn(request)
    }
    
    // Validate session expiry
    if (session.expires_at && session.expires_at * 1000 < Date.now()) {
      logAuthAttempt(request, 'failure', 'Session expired')
      return redirectToSignIn(request)
    }
    
    // Check user role for admin routes
    const user = session.user
    const isAdmin = user.app_metadata?.is_admin || 
                   user.user_metadata?.is_admin || 
                   false
    
    if (!isAdmin) {
      logAuthAttempt(request, 'failure', 'Insufficient permissions')
      return new NextResponse('Forbidden', { status: 403 })
    }
    
    // Validate CSRF token for state-changing requests
    if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(request.method)) {
      if (!validateCSRFToken(request)) {
        logAuthAttempt(request, 'failure', 'Invalid CSRF token')
        return new NextResponse('Forbidden', { status: 403 })
      }
    }
    
    // Add security headers
    response.headers.set('X-Content-Type-Options', 'nosniff')
    response.headers.set('X-Frame-Options', 'DENY')
    response.headers.set('X-XSS-Protection', '1; mode=block')
    response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
    
    // Add user info to headers for downstream use
    response.headers.set('X-User-ID', user.id)
    response.headers.set('X-User-Role', 'admin')
    
    logAuthAttempt(request, 'success')
    return response
    
  } catch (error) {
    console.error('Middleware error:', error)
    logAuthAttempt(request, 'failure', 'Middleware error')
    return new NextResponse('Internal Server Error', { status: 500 })
  }
}

function redirectToSignIn(request: NextRequest): NextResponse {
  const signInUrl = new URL('/admin/auth', request.url)
  signInUrl.searchParams.set('redirectTo', request.nextUrl.pathname + request.nextUrl.search)
  return NextResponse.redirect(signInUrl)
}

// Configure which routes this middleware runs on
export const config = {
  matcher: [
    '/admin/:path*',
    '/api/admin/:path*',
    '/((?!_next/static|_next/image|favicon.ico).*)'
  ]
}
```

### Protected Route Component
```typescript
// src/components/ProtectedRoute.tsx
import React, { useEffect, useState } from 'react'
import { useRouter } from 'next/router'
import { useAuth } from '../contexts/AuthContext'

interface ProtectedRouteProps {
  children: React.ReactNode
  requireAdmin?: boolean
  fallback?: React.ReactNode
  redirectTo?: string
  onUnauthorized?: () => void
}

export default function ProtectedRoute({
  children,
  requireAdmin = true,
  fallback,
  redirectTo = '/admin/auth',
  onUnauthorized
}: ProtectedRouteProps) {
  const { isAuthenticated, isAdmin, loading, initialized } = useAuth()
  const router = useRouter()
  const [shouldRender, setShouldRender] = useState(false)

  useEffect(() => {
    if (!initialized) return

    const checkAccess = () => {
      // Not authenticated
      if (!isAuthenticated) {
        if (onUnauthorized) {
          onUnauthorized()
        } else {
          const redirectUrl = new URL(redirectTo, window.location.origin)
          redirectUrl.searchParams.set('redirectTo', router.asPath)
          router.replace(redirectUrl.toString())
        }
        return false
      }

      // Requires admin but user is not admin
      if (requireAdmin && !isAdmin) {
        if (onUnauthorized) {
          onUnauthorized()
        } else {
          router.replace('/unauthorized')
        }
        return false
      }

      return true
    }

    const hasAccess = checkAccess()
    setShouldRender(hasAccess)
  }, [isAuthenticated, isAdmin, initialized, requireAdmin, router, redirectTo, onUnauthorized])

  // Show loading state
  if (loading || !initialized) {
    if (fallback) {
      return <>{fallback}</>
    }
    
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading...</p>
        </div>
      </div>
    )
  }

  // Don't render children if access check failed
  if (!shouldRender) {
    if (fallback) {
      return <>{fallback}</>
    }
    
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">Access Denied</h2>
          <p className="text-gray-600">You don't have permission to access this page.</p>
        </div>
      </div>
    )
  }

  return <>{children}</>
}

// Higher-order component version
export function withProtectedRoute<P extends object>(
  Component: React.ComponentType<P>,
  options: Omit<ProtectedRouteProps, 'children'> = {}
) {
  return function ProtectedComponent(props: P) {
    return (
      <ProtectedRoute {...options}>
        <Component {...props} />
      </ProtectedRoute>
    )
  }
}

// Hook for programmatic access control
export function useRouteProtection(requireAdmin = true) {
  const { isAuthenticated, isAdmin, loading } = useAuth()
  const router = useRouter()

  const checkAccess = () => {
    if (loading) return { hasAccess: false, loading: true }
    
    if (!isAuthenticated) {
      return { hasAccess: false, loading: false, reason: 'not_authenticated' }
    }
    
    if (requireAdmin && !isAdmin) {
      return { hasAccess: false, loading: false, reason: 'insufficient_permissions' }
    }
    
    return { hasAccess: true, loading: false }
  }

  const redirectToAuth = (redirectTo?: string) => {
    const authUrl = new URL('/admin/auth', window.location.origin)
    authUrl.searchParams.set('redirectTo', redirectTo || router.asPath)
    router.replace(authUrl.toString())
  }

  return {
    ...checkAccess(),
    redirectToAuth
  }
}
```

### Updated Navigation Component
```typescript
// src/components/Navigation.tsx
import React, { useState, useEffect } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/router'
import { useAuth } from '../contexts/AuthContext'
import { 
  Bars3Icon, 
  XMarkIcon, 
  UserCircleIcon,
  ArrowRightOnRectangleIcon,
  Cog6ToothIcon,
  ChartBarIcon,
  DocumentTextIcon,
  CurrencyDollarIcon
} from '@heroicons/react/24/outline'

interface NavigationItem {
  name: string
  href: string
  icon?: React.ComponentType<{ className?: string }>
  requireAuth?: boolean
  requireAdmin?: boolean
  external?: boolean
}

const publicNavigation: NavigationItem[] = [
  { name: 'Menu', href: '/menu' },
  { name: 'Rooms', href: '/rooms' },
  { name: 'Book Now', href: '/booking' },
  { name: 'Contact', href: '/contact' }
]

const adminNavigation: NavigationItem[] = [
  { 
    name: 'Dashboard', 
    href: '/admin/dashboard', 
    icon: ChartBarIcon,
    requireAuth: true,
    requireAdmin: true
  },
  { 
    name: 'Bookings', 
    href: '/admin/bookings', 
    icon: DocumentTextIcon,
    requireAuth: true,
    requireAdmin: true
  },
  { 
    name: 'Menu Management', 
    href: '/admin/menu', 
    icon: DocumentTextIcon,
    requireAuth: true,
    requireAdmin: true
  },
  { 
    name: 'Expenses', 
    href: '/admin/expenses', 
    icon: CurrencyDollarIcon,
    requireAuth: true,
    requireAdmin: true
  },
  { 
    name: 'Settings', 
    href: '/admin/settings', 
    icon: Cog6ToothIcon,
    requireAuth: true,
    requireAdmin: true
  }
]

export default function Navigation() {
  const { isAuthenticated, isAdmin, user, signOut, loading } = useAuth()
  const router = useRouter()
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false)
  const [userMenuOpen, setUserMenuOpen] = useState(false)

  // Close mobile menu on route change
  useEffect(() => {
    const handleRouteChange = () => {
      setMobileMenuOpen(false)
      setUserMenuOpen(false)
    }

    router.events.on('routeChangeStart', handleRouteChange)
    return () => {
      router.events.off('routeChangeStart', handleRouteChange)
    }
  }, [router.events])

  // Close menus on outside click
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element
      if (!target.closest('[data-menu]')) {
        setUserMenuOpen(false)
        setMobileMenuOpen(false)
      }
    }

    document.addEventListener('click', handleClickOutside)
    return () => document.removeEventListener('click', handleClickOutside)
  }, [])

  const handleSignOut = async () => {
    try {
      await signOut()
      router.push('/')
    } catch (error) {
      console.error('Sign out error:', error)
    }
  }

  const isCurrentRoute = (href: string) => {
    return router.pathname === href || router.pathname.startsWith(href + '/')
  }

  const filteredNavigation = [
    ...publicNavigation,
    ...(isAuthenticated && isAdmin ? adminNavigation : [])
  ]

  return (
    <nav className="bg-white shadow-lg" role="navigation" aria-label="Main navigation">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between h-16">
          {/* Logo */}
          <div className="flex items-center">
            <Link href="/" className="flex-shrink-0 flex items-center">
              <span className="text-xl font-bold text-gray-900">Restaurant</span>
            </Link>
          </div>

          {/* Desktop Navigation */}
          <div className="hidden md:flex md:items-center md:space-x-8">
            {filteredNavigation.map((item) => {
              const Icon = item.icon
              const current = isCurrentRoute(item.href)
              
              return (
                <Link
                  key={item.name}
                  href={item.href}
                  className={`inline-flex items-center px-1 pt-1 text-sm font-medium transition-colors duration-200 ${
                    current
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                  aria-current={current ? 'page' : undefined}
                >
                  {Icon && <Icon className="w-4 h-4 mr-2" />}
                  {item.name}
                </Link>
              )
            })}
          </div>

          {/* User Menu */}
          <div className="hidden md:flex md:items-center md:space-x-4">
            {loading ? (
              <div className="animate-pulse">
                <div className="h-8 w-20 bg-gray-200 rounded"></div>
              </div>
            ) : isAuthenticated ? (
              <div className="relative" data-menu>
                <button
                  onClick={() => setUserMenuOpen(!userMenuOpen)}
                  className="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  aria-expanded={userMenuOpen}
                  aria-haspopup="true"
                >
                  <span className="sr-only">Open user menu</span>
                  {user?.adminProfile?.avatar_url ? (
                    <img
                      className="h-8 w-8 rounded-full"
                      src={user.adminProfile.avatar_url}
                      alt={user.adminProfile.full_name || user.email || 'User'}
                    />
                  ) : (
                    <UserCircleIcon className="h-8 w-8 text-gray-400" />
                  )}
                  <span className="ml-2 text-gray-700">
                    {user?.adminProfile?.full_name || user?.email || 'Admin'}
                  </span>
                </button>

                {userMenuOpen && (
                  <div className="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                    <div className="py-1" role="menu" aria-orientation="vertical">
                      <Link
                        href="/admin/profile"
                        className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                        role="menuitem"
                      >
                        Profile Settings
                      </Link>
                      <button
                        onClick={handleSignOut}
                        className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                        role="menuitem"
                      >
                        <ArrowRightOnRectangleIcon className="w-4 h-4 inline mr-2" />
                        Sign Out
                      </button>
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <Link
                href="/admin/auth"
                className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Admin Sign In
              </Link>
            )}
          </div>

          {/* Mobile menu button */}
          <div className="md:hidden flex items-center">
            <button
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
              className="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
              aria-expanded={mobileMenuOpen}
              aria-label="Toggle mobile menu"
            >
              {mobileMenuOpen ? (
                <XMarkIcon className="block h-6 w-6" />
              ) : (
                <Bars3Icon className="block h-6 w-6" />
              )}
            </button>
          </div>
        </div>
      </div>

      {/* Mobile Navigation */}
      {mobileMenuOpen && (
        <div className="md:hidden" data-menu>
          <div className="pt-2 pb-3 space-y-1 sm:px-3">
            {filteredNavigation.map((item) => {
              const Icon = item.icon
              const current = isCurrentRoute(item.href)
              
              return (
                <Link
                  key={item.name}
                  href={item.href}
                  className={`block pl-3 pr-4 py-2 text-base font-medium transition-colors duration-200 ${
                    current
                      ? 'text-blue-600 bg-blue-50 border-r-4 border-blue-600'
                      : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                  }`}
                  aria-current={current ? 'page' : undefined}
                >
                  <div className="flex items-center">
                    {Icon && <Icon className="w-5 h-5 mr-3" />}
                    {item.name}
                  </div>
                </Link>
              )
            })}
          </div>

          {/* Mobile User Section */}
          <div className="pt-4 pb-3 border-t border-gray-200">
            {loading ? (
              <div className="px-4">
                <div className="animate-pulse">
                  <div className="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                  <div className="h-3 bg-gray-200 rounded w-1/2"></div>
                </div>
              </div>
            ) : isAuthenticated ? (
              <>
                <div className="flex items-center px-4">
                  {user?.adminProfile?.avatar_url ? (
                    <img
                      className="h-10 w-10 rounded-full"
                      src={user.adminProfile.avatar_url}
                      alt={user.adminProfile.full_name || user.email || 'User'}
                    />
                  ) : (
                    <UserCircleIcon className="h-10 w-10 text-gray-400" />
                  )}
                  <div className="ml-3">
                    <div className="text-base font-medium text-gray-800">
                      {user?.adminProfile?.full_name || 'Admin User'}
                    </div>
                    <div className="text-sm font-medium text-gray-500">
                      {user?.email}
                    </div>
                  </div>
                </div>
                <div className="mt-3 space-y-1">
                  <Link
                    href="/admin/profile"
                    className="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100"
                  >
                    Profile Settings
                  </Link>
                  <button
                    onClick={handleSignOut}
                    className="block w-full text-left px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100"
                  >
                    Sign Out
                  </button>
                </div>
              </>
            ) : (
              <div className="px-4">
                <Link
                  href="/admin/auth"
                  className="block w-full text-center px-4 py-2 text-base font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md"
                >
                  Admin Sign In
                </Link>
              </div>
            )}
          </div>
        </div>
      )}
    </nav>
  )
}
```

### Admin Layout Component
```typescript
// src/components/AdminLayout.tsx
import React from 'react'
import Head from 'next/head'
import { useRouter } from 'next/router'
import { useAuth } from '../contexts/AuthContext'
import Navigation from './Navigation'
import ProtectedRoute from './ProtectedRoute'
import { AuthErrorBoundary } from './AuthErrorBoundary'

interface AdminLayoutProps {
  children: React.ReactNode
  title?: string
  description?: string
  requireAuth?: boolean
  showNavigation?: boolean
}

interface BreadcrumbItem {
  name: string
  href?: string
}

function generateBreadcrumbs(pathname: string): BreadcrumbItem[] {
  const segments = pathname.split('/').filter(Boolean)
  const breadcrumbs: BreadcrumbItem[] = []
  
  let currentPath = ''
  
  segments.forEach((segment, index) => {
    currentPath += `/${segment}`
    
    // Convert segment to readable name
    const name = segment
      .split('-')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ')
    
    breadcrumbs.push({
      name,
      href: index === segments.length - 1 ? undefined : currentPath
    })
  })
  
  return breadcrumbs
}

export default function AdminLayout({
  children,
  title = 'Admin Dashboard',
  description = 'Restaurant management system',
  requireAuth = true,
  showNavigation = true
}: AdminLayoutProps) {
  const { user, isAuthenticated, loading } = useAuth()
  const router = useRouter()
  
  const breadcrumbs = generateBreadcrumbs(router.pathname)
  const pageTitle = `${title} | Restaurant Admin`

  const content = (
    <AuthErrorBoundary>
      <div className="min-h-screen bg-gray-50">
        <Head>
          <title>{pageTitle}</title>
          <meta name="description" content={description} />
          <meta name="robots" content="noindex, nofollow" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <link rel="icon" href="/favicon.ico" />
        </Head>

        {showNavigation && <Navigation />}

        <div className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
          {/* Breadcrumbs */}
          {breadcrumbs.length > 1 && (
            <nav className="flex mb-6" aria-label="Breadcrumb">
              <ol className="inline-flex items-center space-x-1 md:space-x-3">
                <li className="inline-flex items-center">
                  <a
                    href="/admin/dashboard"
                    className="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600"
                  >
                    <svg className="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    Dashboard
                  </a>
                </li>
                {breadcrumbs.slice(1).map((crumb, index) => (
                  <li key={index}>
                    <div className="flex items-center">
                      <svg className="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd"></path>
                      </svg>
                      {crumb.href ? (
                        <a
                          href={crumb.href}
                          className="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2"
                        >
                          {crumb.name}
                        </a>
                      ) : (
                        <span className="ml-1 text-sm font-medium text-gray-500 md:ml-2">
                          {crumb.name}
                        </span>
                      )}
                    </div>
                  </li>
                ))}
              </ol>
            </nav>
          )}

          {/* Page Header */}
          <div className="mb-6">
            <div className="md:flex md:items-center md:justify-between">
              <div className="flex-1 min-w-0">
                <h1 className="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                  {title}
                </h1>
                {description && (
                  <p className="mt-1 text-sm text-gray-500">
                    {description}
                  </p>
                )}
              </div>
              
              {/* User Info */}
              {isAuthenticated && user && (
                <div className="mt-4 flex md:mt-0 md:ml-4">
                  <div className="flex items-center text-sm text-gray-500">
                    <span>Welcome back, {user.adminProfile?.full_name || user.email}</span>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Main Content */}
          <main className="flex-1">
            {children}
          </main>
        </div>

        {/* Loading Overlay */}
        {loading && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div className="bg-white p-6 rounded-lg shadow-lg">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-4 text-gray-600 text-center">Loading...</p>
            </div>
          </div>
        )}
      </div>
    </AuthErrorBoundary>
  )

  if (requireAuth) {
    return (
      <ProtectedRoute requireAdmin={true}>
        {content}
      </ProtectedRoute>
    )
  }

  return content
}

// Specialized layouts for different admin sections
export function DashboardLayout({ children, ...props }: Omit<AdminLayoutProps, 'title'>) {
  return (
    <AdminLayout title="Dashboard" {...props}>
      {children}
    </AdminLayout>
  )
}

export function BookingsLayout({ children, ...props }: Omit<AdminLayoutProps, 'title'>) {
  return (
    <AdminLayout title="Bookings Management" {...props}>
      {children}
    </AdminLayout>
  )
}

export function MenuLayout({ children, ...props }: Omit<AdminLayoutProps, 'title'>) {
  return (
    <AdminLayout title="Menu Management" {...props}>
      {children}
    </AdminLayout>
  )
}

export function ExpensesLayout({ children, ...props }: Omit<AdminLayoutProps, 'title'>) {
  return (
    <AdminLayout title="Expenses Management" {...props}>
      {children}
    </AdminLayout>
  )
}

export function SettingsLayout({ children, ...props }: Omit<AdminLayoutProps, 'title'>) {
  return (
    <AdminLayout title="Settings" {...props}>
      {children}
    </AdminLayout>
  )
}
```

### Route Protection Hook
```typescript
// src/hooks/useRouteGuard.ts
import { useEffect } from 'react'
import { useRouter } from 'next/router'
import { useAuth } from '../contexts/AuthContext'

interface RouteGuardOptions {
  requireAuth?: boolean
  requireAdmin?: boolean
  redirectTo?: string
  onUnauthorized?: () => void
}

export function useRouteGuard({
  requireAuth = true,
  requireAdmin = false,
  redirectTo = '/admin/auth',
  onUnauthorized
}: RouteGuardOptions = {}) {
  const { isAuthenticated, isAdmin, loading, initialized } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (!initialized || loading) return

    const checkAccess = () => {
      if (requireAuth && !isAuthenticated) {
        if (onUnauthorized) {
          onUnauthorized()
        } else {
          const authUrl = new URL(redirectTo, window.location.origin)
          authUrl.searchParams.set('redirectTo', router.asPath)
          router.replace(authUrl.toString())
        }
        return false
      }

      if (requireAdmin && !isAdmin) {
        if (onUnauthorized) {
          onUnauthorized()
        } else {
          router.replace('/unauthorized')
        }
        return false
      }

      return true
    }

    checkAccess()
  }, [isAuthenticated, isAdmin, initialized, loading, requireAuth, requireAdmin, router, redirectTo, onUnauthorized])

  return {
    isAuthenticated,
    isAdmin,
    loading: loading || !initialized,
    hasAccess: (!requireAuth || isAuthenticated) && (!requireAdmin || isAdmin)
  }
}
```

### Next.js Middleware Configuration
```typescript
// middleware.ts (in project root)
import { middleware as authMiddleware } from './src/middleware/auth'

export default authMiddleware

export const config = {
  matcher: [
    '/admin/:path*',
    '/api/admin/:path*',
    '/((?!_next/static|_next/image|favicon.ico|public).*)'
  ]
}
```

### Unauthorized Page
```typescript
// pages/unauthorized.tsx
import React from 'react'
import Link from 'next/link'
import { useAuth } from '../src/contexts/AuthContext'

export default function UnauthorizedPage() {
  const { isAuthenticated } = useAuth()

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 text-center">
        <div>
          <h2 className="mt-6 text-3xl font-extrabold text-gray-900">
            Access Denied
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            {isAuthenticated 
              ? "You don't have permission to access this resource."
              : "Please sign in to access this page."
            }
          </p>
        </div>
        
        <div className="space-y-4">
          {!isAuthenticated ? (
            <Link
              href="/admin/auth"
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Sign In
            </Link>
          ) : (
            <Link
              href="/admin/dashboard"
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Go to Dashboard
            </Link>
          )}
          
          <Link
            href="/"
            className="group relative w-full flex justify-center py-2 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Back to Home
          </Link>
        </div>
      </div>
    </div>
  )
}
```

### Testing Infrastructure
```typescript
// __tests__/components/ProtectedRoute.test.tsx
import { render, screen, waitFor } from '@testing-library/react'
import { useRouter } from 'next/router'
import ProtectedRoute from '../../src/components/ProtectedRoute'
import { useAuth } from '../../src/contexts/AuthContext'

// Mock dependencies
jest.mock('next/router')
jest.mock('../../src/contexts/AuthContext')

const mockPush = jest.fn()
const mockReplace = jest.fn()

;(useRouter as jest.Mock).mockReturnValue({
  push: mockPush,
  replace: mockReplace,
  asPath: '/admin/dashboard'
})

const TestComponent = () => <div>Protected Content</div>

describe('ProtectedRoute', () => {
  beforeEach(() => {
    jest.clearAllMocks()
  })

  test('renders children when user is authenticated and admin', () => {
    ;(useAuth as jest.Mock).mockReturnValue({
      isAuthenticated: true,
      isAdmin: true,
      loading: false,
      initialized: true
    })

    render(
      <ProtectedRoute>
        <TestComponent />
      </ProtectedRoute>
    )

    expect(screen.getByText('Protected Content')).toBeInTheDocument()
  })

  test('redirects to auth when user is not authenticated', async () => {
    ;(useAuth as jest.Mock).mockReturnValue({
      isAuthenticated: false,
      isAdmin: false,
      loading: false,
      initialized: true
    })

    render(
      <ProtectedRoute>
        <TestComponent />
      </ProtectedRoute>
    )

    await waitFor(() => {
      expect(mockReplace).toHaveBeenCalledWith(
        expect.stringContaining('/admin/auth')
      )
    })
  })

  test('shows access denied when user is authenticated but not admin', () => {
    ;(useAuth as jest.Mock).mockReturnValue({
      isAuthenticated: true,
      isAdmin: false,
      loading: false,
      initialized: true
    })

    render(
      <ProtectedRoute requireAdmin={true}>
        <TestComponent />
      </ProtectedRoute>
    )

    expect(screen.getByText('Access Denied')).toBeInTheDocument()
    expect(screen.queryByText('Protected Content')).not.toBeInTheDocument()
  })

  test('shows loading state when auth is loading', () => {
    ;(useAuth as jest.Mock).mockReturnValue({
      isAuthenticated: false,
      isAdmin: false,
      loading: true,
      initialized: false
    })

    render(
      <ProtectedRoute>
        <TestComponent />
      </ProtectedRoute>
    )

    expect(screen.getByText('Loading...')).toBeInTheDocument()
  })
})
```

### Performance Monitoring
```typescript
// src/lib/monitoring/routePerformance.ts
interface RouteMetrics {
  path: string
  authCheckTime: number
  renderTime: number
  timestamp: number
}

class RoutePerformanceMonitor {
  private metrics: RouteMetrics[] = []
  private maxMetrics = 1000

  recordRouteAccess(path: string, authCheckTime: number, renderTime: number) {
    const metric: RouteMetrics = {
      path,
      authCheckTime,
      renderTime,
      timestamp: Date.now()
    }

    this.metrics.push(metric)
    
    // Keep only recent metrics
    if (this.metrics.length > this.maxMetrics) {
      this.metrics = this.metrics.slice(-this.maxMetrics)
    }
  }

  getAverageAuthTime(path?: string): number {
    const filteredMetrics = path 
      ? this.metrics.filter(m => m.path === path)
      : this.metrics
    
    if (filteredMetrics.length === 0) return 0
    
    const total = filteredMetrics.reduce((sum, m) => sum + m.authCheckTime, 0)
    return total / filteredMetrics.length
  }

  getSlowRoutes(threshold = 100): RouteMetrics[] {
    return this.metrics.filter(m => m.authCheckTime > threshold)
  }

  getMetricsSummary() {
    const pathGroups = this.metrics.reduce((acc, metric) => {
      if (!acc[metric.path]) {
        acc[metric.path] = []
      }
      acc[metric.path].push(metric)
      return acc
    }, {} as Record<string, RouteMetrics[]>)

    return Object.entries(pathGroups).map(([path, metrics]) => ({
      path,
      count: metrics.length,
      avgAuthTime: metrics.reduce((sum, m) => sum + m.authCheckTime, 0) / metrics.length,
      avgRenderTime: metrics.reduce((sum, m) => sum + m.renderTime, 0) / metrics.length,
      maxAuthTime: Math.max(...metrics.map(m => m.authCheckTime)),
      maxRenderTime: Math.max(...metrics.map(m => m.renderTime))
    }))
  }
}

export const routePerformanceMonitor = new RoutePerformanceMonitor()
```

### Testing Checklist
- [ ] Authentication middleware validates sessions correctly
- [ ] Middleware blocks unauthorized access to admin routes
- [ ] Middleware handles expired sessions appropriately
- [ ] Rate limiting works correctly
- [ ] CSRF protection validates tokens
- [ ] Protected routes redirect unauthenticated users
- [ ] Protected routes block non-admin users from admin routes
- [ ] Navigation shows correct options based on auth state
- [ ] Navigation handles authentication state changes
- [ ] User menu works correctly
- [ ] Mobile navigation functions properly
- [ ] Breadcrumbs generate correctly
- [ ] Admin layout displays user information
- [ ] Loading states show appropriate feedback
- [ ] Error boundaries catch route protection errors
- [ ] Accessibility features work correctly
- [ ] Responsive design works on all devices
- [ ] Performance monitoring captures metrics
- [ ] Security headers are properly set
- [ ] TypeScript types are correct

### Documentation Requirements
- Document route protection patterns and best practices
- Create middleware configuration guide
- Document navigation component customization
- Create admin layout usage examples
- Document security considerations and best practices
- Create troubleshooting guide for route protection issues
- Document performance optimization techniques
- Create accessibility compliance documentation