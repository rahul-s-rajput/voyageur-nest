# Status
Planned

# Story: Telegram Bot - Expense Capture with Photo Receipt
Allow capturing an expense via `/expense` command, supporting text prompts for amount/category/date and photo upload to Supabase Storage. Create expense record linked to the selected property.

## Prerequisites
- `6.1`–`6.2` completed.
- Bot refactor is in place: `supabase/functions/telegram-bot/index.ts` registers modular features.
- Implement this story as a new feature module: `supabase/functions/telegram-bot/features/expense.ts` and register it from `index.ts`.
- Inject dependencies from `index.ts` similar to bookings: `{ supabase, BOT_TIMEZONE, formatDateInTZ, getSelectedPropertyId, loadWizard, saveWizard, clearWizard }`.
- Expense service (optional): `src/services/expenseService.ts`; types in `src/types/expenses.ts` (only reuse if Deno-compatible/shared without React/browser deps).
- Storage bucket for receipts exists (see `storage_receipts_setup.sql`).

## Acceptance Criteria
- `/expense` wizard collects: amount, category (optional), date (default today), currency (default property currency or fallback), and photo receipt (optional but recommended).
 - If a photo is sent during the flow, it is uploaded to Storage and the Storage path is saved in `receipt_path` in the expense record. A public/signed URL can be derived on read if needed.
- Record is created with `property_id`, `approval_status` default (e.g., `pending`), and metadata.
 - Property scoping uses `getSelectedPropertyId(ctx)`; wizard state stored via `loadWizard`/`saveWizard`/`clearWizard` in `supabase/functions/telegram-bot/state/wizard.ts`.

## Tasks
- Command `/expense`
  - Add a new `registerExpenseCapture(bot, deps)` in `features/expense.ts` and register from `index.ts`.
  - Prompt user for amount → category (optional) → date (default today via `formatDateInTZ`) → currency (default "INR" or property currency) → photo (optional).
  - Accept both text and photo messages during the wizard; route `bot.on("message:photo")` to capture receipt when wizard step expects a photo.
  - Create expense via direct insert into `expenses` or via `expenseService` (if extracted to Deno-compatible shared module).
- Storage integration
  - Use Supabase Deno client (service role) already constructed in `index.ts`.
  - Canonical path: `receipts/{propertyId}/{yyyy-mm}/{uuid}.jpg`.
  - Compute `{yyyy-mm}` using `formatDateInTZ(new Date(), BOT_TIMEZONE)` and string ops.

## Dev Notes
- GrammY file retrieval (no plugins assumed):
  ```ts
  // message handler when awaiting photo
  const sz = ctx.message?.photo?.at(-1); // largest size
  if (!sz) { await ctx.reply("Please send a photo receipt or /skip"); return; }
  const file = await ctx.api.getFile(sz.file_id);
  const token = Deno.env.get("TELEGRAM_BOT_TOKEN")!;
  const url = `https://api.telegram.org/file/bot${token}/${file.file_path}`;
  const bytes = new Uint8Array(await (await fetch(url)).arrayBuffer());
  await supabase.storage.from("receipts").upload(path, bytes, { contentType: "image/jpeg", upsert: false });
  ```
- Insert example:
  ```ts
  await supabase.from("expenses").insert({
    property_id: propertyId,
    amount: input.amount,
    expense_date: input.date,
    currency: input.currency ?? "INR",
    category_id: input.categoryId ?? null,
    approval_status: "pending",
    receipt_path: path,
  });
  ```
 - Wizard state keys can be: `expense_amount`, `expense_category`, `expense_date`, `expense_currency`, `expense_receipt`.
 - Use `clearWizard(chatId)` when the expense is saved or cancelled.

## Testing
- Create an expense with and without a photo; verify storage object and DB record.
- Validate malformed amount or date prompts re-ask properly.
 - Verify property scoping: switch properties with `/switch` and ensure new expenses attach correct `property_id`.

## Change Log
- 2025-08-21: Initial story draft created.
 - 2025-08-22: Aligned with refactored Telegram bot (modular feature, DI, wizard state, grammY file retrieval).
