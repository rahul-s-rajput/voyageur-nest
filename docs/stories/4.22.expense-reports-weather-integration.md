# Story 4.22: Weather API Integration & Demand Correlation

## Status
Ready for Review

## Story
As an operations planner,
I want to correlate weather with expenses and occupancy,
So that I can plan budgets and operations based on expected demand in Manali.

## Acceptance Criteria
1. Weather Provider Integration
   - Fetch daily weather (temp min/max, precipitation, snow, humidity)
   - Manali coordinates with property-level override (Old Manali, Baror)
   - Rate-limit handling and retries
2. Correlation Views
   - Overlay weather on expense heatmap/time-series
   - Pearson correlation coefficient displayed per period
   - Toggle overlays (Temp, Rain/Snow)
3. Seasonal Insights
   - Highlight weather-driven peaks (heating in winter, cooling in summer)
   - Export includes weather context
4. Resilience
   - Graceful degradation when API unavailable
   - Cached results with TTL; unit conversions (metric)

## Tasks / Subtasks
- [ ] WeatherService
  - [ ] API client with caching (Open-Meteo/OpenWeather configurable)
  - [ ] Env config: `WEATHER_API_BASE`, `WEATHER_API_KEY`
  - [ ] Rate limiting + backoff
- [ ] Hook + Storage
  - [ ] `useWeather({ propertyId, start, end })`
  - [ ] IndexedDB cache (recent 90 days)
- [ ] UI Overlays
  - [ ] `WeatherOverlay` for charts (line for temp, bars for precip)
  - [ ] `WeatherLegend` + toggles
  - [ ] Tooltips: weather + expense values
- [ ] Background Prefetch (optional)
  - [ ] Job/function to prefetch daily weather

## Dev Notes
- References: improvement plan (Advanced Charts, Predictive Features)
- Suggested locations:
  - `src/services/WeatherService.ts`
  - `src/hooks/useWeather.ts`
  - `src/components/Reports/overlays/WeatherOverlay.tsx`
- Data alignment: ensure timezone match with expense timestamps
- Guest House Context: winter heating spikes; monsoon-related access/logistics

## Testing
- [ ] API success/failure paths; rate-limit simulation
- [ ] Metric units correct; timezone alignment
- [ ] Correlation coefficients stable for sample data
- [ ] Cache hits reduce API calls (>80% after warmup)
- [ ] Dark mode overlay colors legible

## Success Metrics
- Weather overlay usage: >30% of report sessions
- API errors <1% of calls (with caching)
- Correlation visible in monthly review exports

## Integration Points
- Forecasting (Story 4.11): weather as feature
- Advanced Charts (Story 4.6): overlays on heatmap/line charts
- Comparison (Story 4.10): weather-aware comparisons

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation | Team |
