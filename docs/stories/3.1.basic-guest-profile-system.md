# Story 3.1 — Basic Guest Profile System

- Status: Ready for Dev
- Epic: Guest Profiles & Recognition
- Owner: Property Management
- Sprint Target: 1 Sprint

## User Story
As a property manager, I want a basic guest profile system that consolidates a guest’s identity, booking history, spend, and notes so that staff can quickly recognize repeat guests, understand prior context, and provide better service.

## Acceptance Criteria
- [A1] One guest profile per primary booking contact
  - When a booking/check-in is created, the system must create or link a single `guest_profiles` record using email/phone match.
  - No duplicate profiles should be created when an existing guest is found by email or phone.
  - Bookings must reference guest profiles via `bookings.guest_profile_id`.
- [A2] Booking history with total spend
  - A guest’s profile view shows all associated bookings (most recent first) with key fields including `check_in`, `check_out`, `no_of_pax`, `total_amount`, `status`.
  - Total lifetime spend and total stays are visible (from `guest_profiles.total_spent`, `guest_profiles.total_stays`).
- [A3] Track group size changes across visits
  - Show per-booking group size using `bookings.no_of_pax` and a simple classification chip per booking: Solo (1), Couple (2), Family (3–4), Group (5+).
  - Show typical group size from `guest_profiles.typical_group_size`.
- [A4] Additional guest names for group bookings
  - Support display of `bookings.additional_guest_names` in the guest profile’s booking history when present.
  - (Create/edit of this field remains in booking flows; this story only consumes/displays it.)
- [A5] Communication history tracking (emails)
  - Show a basic list (latest 5) of related `email_messages` where the guest’s `email` matches `sender` or `recipient`.
  - Show counts and the last received/sent date.
  - Out-of-scope: deep threading, attachments preview, AI extractions.
- [A6] Notes field
  - `guest_profiles.notes` is editable by staff and visible in profile view.
- [A7] Guest lifetime value & repeat identification
  - Show “Lifetime Value” from `total_spent` and badge “Repeat” if `total_stays > 1`, else “New”.
- [A8] Track preferences for Manali experiences
  - MVP approach: allow lightweight tagging inside `notes` using hashtags (e.g., `#adventure`, `#relaxation`, `#cultural`). Parse and display chips. No schema changes in this story.
- [A9] RLS/GDPR adherence
  - All reads/writes conform to RLS policies and consent flags; `email_marketing_consent`, `sms_marketing_consent`, `data_retention_consent` editable in UI.

## Scope
- In-scope
  - Guest identity profile (`guest_profiles`): basic info, consents, notes, stats.
  - Linkage from bookings via `guest_profile_id`.
  - Display of booking history and derived group-size chips.
  - Minimal communications history via `email_messages` by email matching.
- Out-of-scope (future stories)
  - Dedicated preferences schema/UX beyond notes tags.
  - Review ingestion and cross-channel communications linking.
  - Merging duplicate profiles as a bulk/admin tool.

## Backend — Design & Tasks
- Data model (existing; verify applied)
  - `guest_profiles` fields per `guest_profiles_migration.sql`: `name`, `email`, `phone`, `address`, `city`, `state`, `country`, `total_stays`, `total_spent`, `last_stay_date`, `typical_group_size`, marketing/data consents, `notes`, timestamps.
  - `bookings` fields used: `guest_profile_id`, `no_of_pax`, `additional_guest_names`, `total_amount`, `status`, `payment_status`, `check_in`, `check_out`.
  - Stats trigger `update_guest_profile_stats()` updates `total_stays`, `total_spent`, `last_stay_date`, `typical_group_size` based on `bookings`.
- Services (existing; extend minimally)
  - Keep using `GuestProfileService.createGuestProfile()`, `getGuestProfile()`, `updateGuestProfile()`, `searchGuestProfiles()`, `getGuestBookingHistory()`, `linkGuestToBooking()`, `updatePrivacySettings()` in `src/services/guestProfileService.ts`.
  - NEW: `GuestProfileService.getCommunicationHistoryByEmail(email: string)` (MVP)
    - Source: `email_messages` table from `email_ingestion_migration.sql`.
    - Filter where `sender` ilike %email% OR `recipient` ilike %email%.
    - Return ordered by `received_at DESC`, with fields `id, subject, sender, recipient, received_at`.
- RLS & security
  - Ensure `guest_profiles` policies from `fix_guest_profiles_rls.sql` are in place (anon insert for check-in, authenticated CRUD).
  - No changes to RLS in this story; read-only access to `email_messages` should be restricted to authenticated users.

### Backend Checklist
- [ ] Verify migrations applied: `guest_profiles_migration.sql` (includes `bookings.additional_guest_names` and stats trigger).
- [ ] Implement/read `getCommunicationHistoryByEmail()` with pagination limit (default 5).
- [ ] Ensure `getGuestBookingHistory()` returns `no_of_pax` and maps `booking_id`.
- [ ] Confirm linking flow via `linkGuestToBooking()` works in booking creation/edit.

## Frontend — Design & Tasks
- Components to use
  - `src/components/GuestProfileForm.tsx`: ensure editable fields for basic info, consents, and `notes`.
  - `src/components/GuestProfileList.tsx`: list includes name, contact, location, `total_stays`, `total_spent`, `last_stay_date` with quick repeat/new badge.
  - `src/components/GuestProfileView.tsx`: tabs for Profile, Booking History, Privacy/Consents, and a lightweight Communications section.
  - `src/components/PropertyManagement/GuestRecognition.tsx`: reflect repeat/new and summary stats.
- UI specifics
  - Booking History tab: show table with columns [Check-in, Check-out, Pax, Group Type, Amount, Status, Additional Names].
    - Group Type derived from `no_of_pax`: 1 Solo; 2 Couple; 3–4 Family; 5+ Group.
    - Show `additional_guest_names` if present.
  - Communications section: below tabs or as a simple panel in Profile tab.
    - Show count and the latest 5 `email_messages` for the guest email.
  - Notes: textarea in form and read view. Render hashtag tags as chips.
  - Consents: toggle switches wired to `updatePrivacySettings()`.

### Frontend Checklist
- [ ] `GuestProfileForm`: validate name required; show consents toggles; include `notes` textarea.
- [ ] `GuestProfileList`: display repeat/new via `total_stays`; sortable by last stay and name.
- [ ] `GuestProfileView`:
  - [ ] Load `getGuestProfile()` + `getGuestBookingHistory()` in parallel.
  - [ ] Compute and display group-size chip per booking; show `additional_guest_names`.
  - [ ] Add Communications panel calling `getCommunicationHistoryByEmail(guest.email)` if `guest.email` exists.
  - [ ] Allow editing `notes` and consents.

## Testing Strategy
- Unit tests (services)
  - `GuestProfileService.findGuestByContact()` matches by email/phone and avoids duplicates.
  - `getGuestBookingHistory()` returns map with `booking_id` and `no_of_pax` populated.
  - `getCommunicationHistoryByEmail()` filters and orders correctly; respects limit.
- Integration tests
  - Create booking ➜ ensure `guest_profiles` created/linked and stats updated by trigger.
  - Create multiple bookings with varying `no_of_pax` ➜ check group chip mapping and `typical_group_size` visibility.
  - Add `additional_guest_names` on a booking ➜ verify display in profile view.
- Manual QA checklist
  - [ ] Create profile via form; confirm appears in list and view.
  - [ ] Create booking with same email ➜ profile links, no duplicate created.
  - [ ] Verify repeat badge appears on second stay.
  - [ ] Verify lifetime value equals sum of paid/partial bookings (as per trigger logic).
  - [ ] Notes hashtags render as chips.
  - [ ] Communications show for matched email (if messages exist).

## Definition of Done (DoD)
- All Acceptance Criteria [A1–A9] met in UI and backed by services.
- RLS policies verified; no unauthorized access paths.
- No console errors; TypeScript passes; basic a11y on forms; mobile layout acceptable.
- Story document committed under `docs/stories/3.1.basic-guest-profile-system.md` with references.

## References
- Migrations: `guest_profiles_migration.sql`, `fix_guest_profiles_rls.sql`, `email_ingestion_migration.sql`.
- Services: `src/services/guestProfileService.ts`.
- Types: `src/types/guest.ts` (`GuestProfile`, `GuestBookingHistory`).
- Components: `src/components/GuestProfileForm.tsx`, `src/components/GuestProfileList.tsx`, `src/components/GuestProfileView.tsx`, `src/components/PropertyManagement/GuestRecognition.tsx`.
- Booking service for linkage patterns: `src/services/roomBookingService.ts`.
