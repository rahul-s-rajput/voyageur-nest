# Status
Planned

# Story: Security, RLS, and Testing Plan
Harden property-scoped access and provide a full testing strategy across DB, services, UI, and bot.

## Prerequisites
- Schema and services ready (`7.1`, `7.2`).

## Acceptance Criteria
- RLS policies in place with explicit select/insert/update/delete policies.
- Basic test data seeding guide exists.
- Documented test cases for voids, refunds, and discount math.
 - Testing instructions include how to set property scope via `set_config('request.jwt.claims', ...)` and fallback.

## Tasks
- Document RLS policies modeled on `menu_items`/`expenses`.
- Add a test checklist for DB (RLS), services, UI, bot.
- Provide sample SQL for seed data.
 - Add cross-property negative tests and ensure they fail under RLS.
 - Add tests for property consistency triggers rejecting mismatched `property_id`.
 - Optionally note `ALTER TABLE ... FORCE ROW LEVEL SECURITY;` for stricter environments.

## Dev Notes
- Consider a read-only role for reporting if needed.
 - Use:
   ```sql
   begin; set role authenticated; select set_config(
     'request.jwt.claims',
     json_build_object('role','authenticated','property_id','<property-uuid>')::text,
     true
   );
   -- ... run tests ...
   rollback;
   ```
 - If claims injection is blocked, fallback to `select set_config('request.property_id','<uuid>',true);` if supported.

## Testing
- DB: attempt cross-property access; ensure denied.
- Services/UI/bot: run through main flows; verify aggregates vs view.
 - Verify triggers by attempting to insert a child row with a different `property_id` than the parent booking; expect an error.
 - Validate that voided rows (`is_voided = true`) are excluded from totals.

## Change Log
- 2025-08-22: Story drafted.
