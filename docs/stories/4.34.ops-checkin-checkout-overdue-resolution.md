# 4.34 Operational Compliance – Overdue Check-in/Check-out Resolution (Alerts, No Automation)

## Status
Proposed

## Prerequisites
- Story 4.33 (Today’s Enforcement) created and agreed as baseline.
- Schema: `public.bookings` with `check_in DATE`, `check_out DATE`, `status` in ('confirmed','pending','checked-in','checked-out'), `cancelled BOOLEAN` (`database.sql`).
- Index: `bookings(check_in, check_out)` (`comprehensive_rls_policies_migration.sql`).
- UI shells exist: `src/components/EnhancedKPIDashboard.tsx`, `src/components/MobileQuickStats.tsx`, `src/components/BookingManagement.tsx`, optional `src/components/BookingDetails.tsx`.

## Story
As Ops, I need a clear list of bookings that are overdue from previous days (e.g., guests who never got checked in or never checked out), so I can resolve or regularize those cases. The system must not auto-mutate data—only surface overdue cases and provide actions.

## Acceptance Criteria
- View `public.booking_enforcement_violations_overdue` exists to return rows where:
  - Overdue check-in: `check_in < current_date` AND `cancelled = false` AND `status NOT IN ('checked-in','checked-out')`.
  - Overdue check-out: `check_out < current_date` AND `cancelled = false` AND `status <> 'checked-out'`.
  - Returns `id, property_id, room_no, guest_name, check_in, check_out, status, cancelled, violation_type` where `violation_type` ∈ ('check-in-overdue','check-out-overdue').
- Booking Management adds an "Overdue" preset/tab showing only the overdue view rows, with clear badges and the same four CTAs:
  - For `check-in-overdue`: [Mark Checked-In], [Cancel]
  - For `check-out-overdue`: [Check-Out], [Extend]
- Resolving a row (via CTA) removes it from the Overdue list immediately after success.
- Dashboard (optional): a small "Overdue" badge/counter if > 0. Clicking takes the user to the Overdue preset.

## Non-Goals
- No scheduled jobs, cron, or automatic changes.
- No push notifications. Pull via UI only.

## Tasks
- SQL
  - Create `public.booking_enforcement_violations_overdue` with the logic above.
- Service
  - Extend `src/services/bookingComplianceService.ts`:
    - `getOverdueCounts(propertyId?: string)` → `{ overdueCheckIns: number, overdueCheckOuts: number }`.
    - `getOverdueViolations(propertyId?: string)` → rows from the overdue view.
- UI
  - `BookingManagement.tsx`: add "Overdue" preset/tab, list rows with badges and CTAs.
  - `EnhancedKPIDashboard.tsx` (optional): show small Overdue counter badge next to Today banner or as a secondary notice when counts > 0.
  - `MobileQuickStats.tsx` (optional): add a third compact badge for Overdue aggregate.
- Access & Performance
  - Property filter applied in queries when a property is selected.
  - Verify index usage; consider composite indexes if necessary (e.g., partial indexes on non-cancelled rows) if performance requires.

## Dev Notes
- Suggested SQL for Overdue view (reference):
  ```sql
  CREATE OR REPLACE VIEW public.booking_enforcement_violations_overdue AS
  SELECT 
    b.id,
    b.property_id,
    b.room_no,
    b.guest_name,
    b.check_in,
    b.check_out,
    b.status,
    b.cancelled,
    CASE 
      WHEN b.check_in < current_date AND NOT b.cancelled AND b.status NOT IN ('checked-in','checked-out')
        THEN 'check-in-overdue'
      WHEN b.check_out < current_date AND NOT b.cancelled AND b.status <> 'checked-out'
        THEN 'check-out-overdue'
    END AS violation_type
  FROM public.bookings b
  WHERE (b.check_in < current_date AND NOT b.cancelled AND b.status NOT IN ('checked-in','checked-out'))
     OR (b.check_out < current_date AND NOT b.cancelled AND b.status <> 'checked-out');
  ```
- Keep overdue and today lists mutually exclusive by definition (`< current_date` vs `= current_date`).
- If desired, allow sorting by days overdue (`GREATEST(current_date - check_in, current_date - check_out)` for display only).

## Testing
- Seed data covering both overdue scenarios and verify counts/lists.
- Verify that acting on a row (e.g., Cancel) removes it from the Overdue list.
- Verify property-scoped results and performance (use explain analyze in local DB if needed).

## Change Log
- 2025-08-26: Initial story drafted (overdue alerts without automation).
