# Status
In Progress

# Story: Telegram Bot - Today's Operations (/today)
Provide a concise summary of today's check-ins, check-outs, and amounts due for the selected property.

## Prerequisites
- `6.1`–`6.2` completed.
- Bot refactor is in place: `supabase/functions/telegram-bot/index.ts`, `supabase/functions/telegram-bot/features/core.ts`, `supabase/functions/telegram-bot/features/booking.ts`.
- Implement this story as a new feature module: `supabase/functions/telegram-bot/features/today.ts` and register it from `supabase/functions/telegram-bot/index.ts`.
- Use shared helpers from `supabase/functions/telegram-bot/utils.ts` (e.g., `formatDateInTZ`) and inject dependencies (`supabase`, `BOT_TIMEZONE`, `getSelectedPropertyId`) from `index.ts` similar to `registerBooking()`.

## Acceptance Criteria
- `/today` displays:
  - Count of check-ins today.
  - Count of check-outs today.
  - Total amount due today (if payment fields exist) or show "N/A" gracefully.
- Output is compact and readable on mobile.
 - Property scoping uses `getSelectedPropertyId(ctx)` (same pattern as bookings feature).

## Tasks
- Command `/today`
  - Add a new `registerTodayOps(bot, deps)` in `supabase/functions/telegram-bot/features/today.ts`.
  - From `index.ts`, call `registerTodayOps(bot, { supabase, BOT_TIMEZONE, formatDateInTZ, getSelectedPropertyId })`.
  - Fetch bookings for the selected `propertyId` where date = today (in `BOT_TIMEZONE`).
  - Compute counts and amounts, reply with a 3–6 line summary.
- Date handling
  - Use consistent timezone via `formatDateInTZ(date, BOT_TIMEZONE)` from `utils.ts`. Support override through `BOT_TIMEZONE` env; default to IST.

## Dev Notes
- Module shape and query example:
  ```ts
  // features/today.ts
  import type { Bot } from "https://deno.land/x/grammy/mod.ts";
  export function registerTodayOps(bot: Bot, deps: { supabase: any; BOT_TIMEZONE: string; formatDateInTZ: (d: Date, tz: string)=>string; getSelectedPropertyId: (ctx:any)=>Promise<string|null>; }) {
    const { supabase, BOT_TIMEZONE, formatDateInTZ, getSelectedPropertyId } = deps;
    bot.command("today", async (ctx) => {
      const pid = await getSelectedPropertyId(ctx); if (!pid) return;
      const today = formatDateInTZ(new Date(), BOT_TIMEZONE);
      const { data } = await supabase
        .from("bookings")
        .select("check_in, check_out, total_amount, payment_status")
        .eq("property_id", pid)
        .or(`check_in.eq.${today},check_out.eq.${today}`);
      // compute counts/sums and reply
    });
  }
  ```
 - If payment fields are not uniform, sum only where `payment_status = 'unpaid'` if available.

## Testing
- Seed a few bookings for today and verify numbers.
- Validate formatting is readable on Telegram mobile.

## Change Log
- 2025-08-21: Initial story draft created.
- 2025-08-22: Aligned with refactored Telegram bot (modular features, DI, correct paths).
- 2025-08-22: Implementation started — created `supabase/functions/telegram-bot/features/today.ts`, added `/today` to `BASE_COMMANDS`, and registered via `registerTodayOps()` from `supabase/functions/telegram-bot/index.ts`.
