# Story 4.5: Reports & Analytics - KPI Cards

## Status
Ready for Review

## Story
As a property manager,
I want enhanced KPI cards with sparklines, comparison metrics, and drill-down actions,
So that I can quickly understand trends and open detailed views for deeper analysis.

## Acceptance Criteria
1. Sparklines visible on desktop and mobile
2. Hover shows data points on sparkline
3. Color coding for positive/negative trends
4. MoM and YoY comparison values displayed with arrows
5. Color-coded indicators (green up, red down)
6. Tooltips with detailed breakdowns
7. Clicking a KPI opens a detailed modal/drawer with smooth transitions
8. Back navigation from detail view is implemented
9. Real-time updates with visual indicator when new data arrives
10. Dark mode support with proper color adjustments
11. Seasonal context indicators (Peak/Moderate/Low) for guest house operations
12. PWA offline support - cached KPI values available offline

## Tasks / Subtasks
- [ ] Implement `EnhancedKPICard` with sparkline using Recharts
  - [ ] Add props: `title`, `value`, `change`, `changeLabel`, `sparklineData`, `icon`, `color`, `onClick`, `isLive`, `lastUpdated`, `seasonalContext`
  - [ ] Color and trend icon logic (up/down/flat)
  - [ ] 7-day rolling trend mini-chart
  - [ ] Touch targets minimum 44x44px
- [ ] Add MoM/YoY comparison display with arrows and tooltips
- [ ] Wire KPI onClick to open detailed modal/drawer
- [ ] Ensure mobile responsiveness and touch targets
- [ ] Implement real-time data polling (30s intervals)
- [ ] Add dark mode color schemes
- [ ] Add seasonal badge (Peak Season, Low Season, etc.)
- [ ] Implement service worker for offline caching

## Dev Notes
- Reference: `docs/implementation-plans/expense-reports-ui-improvement-plan.md` (Phase 1 - Task 1.1)
- Component guide: `docs/implementation-plans/expense-reports-components-guide.md` → `EnhancedKPICard`
- Suggested locations:
  - Component: `src/components/ReportsAnalytics/charts/EnhancedKPICard.tsx`
  - Modal/Drawer: `src/components/ReportsAnalytics/charts/KPIDetailDrawer.tsx`
  - Real-time hook: `src/hooks/useRealtimeExpenses.ts`
  - Theme context: `src/contexts/ThemeContext.tsx`
- Foundation: Story 4.0 provides base architecture
- Location: New ReportsAnalytics section (not ExpenseManagement)
- No legacy code dependencies
- Note: Clean implementation without legacy constraints
- UI libs: Shadcn UI + Recharts
- Performance targets:
  - Initial render: <100ms
  - Sparkline animation: <16ms per frame
  - Touch response: <100ms
- Guest house context:
  - Integrate with seasonal pricing (Peak: May-Jun, Oct-Nov)
  - Show occupancy correlation with expenses

## Testing
- [ ] Desktop and mobile: sparkline renders, hover shows data points
- [ ] Visual checks: green up/red down, correct arrows
- [ ] Accessibility: tab/enter activates onClick, tooltips announced
- [ ] Modal/drawer opens/closes with smooth transitions and back works
- [ ] Real-time updates: data refreshes without flicker
- [ ] Dark mode: all colors have sufficient contrast (WCAG AA)
- [ ] Offline mode: cached values display with offline indicator
- [ ] Performance: <2s initial load, <100ms interaction response
- [ ] Touch targets: minimum 44x44px on mobile
- [ ] Seasonal indicators display correctly for Manali properties

## Success Metrics
- Load time: <2 seconds for all KPI cards
- User interaction: >95% successful first attempts
- Real-time accuracy: 100% data consistency
- Mobile usage: >40% of views from mobile devices

## Integration Points
- Expense approval workflow: KPIs update after approval/rejection
- Receipt OCR: Automatic expense categorization reflects in KPIs
- Multi-property: Separate KPIs for Old Manali vs Baror properties
- Budget alerts: KPI cards show warning when approaching limits

## Prerequisites
- Story 4.0 (Reports & Analytics Foundation) must be completed

## Dependencies
- 4.17: Real-time Updates & Auto-refresh — supplies live KPI refresh and last-updated indicators
- 4.18: Dark Mode & Print Support — provides theme tokens and print styles for KPI cards
- 4.19: PWA & Offline Support — enables offline KPI caching and offline/online indicators
- 4.20: Mobile UI Enhancements — bottom sheet detail drawers, FAB actions, and haptics used by KPI detail views
- 4.24: Mobile Push Notifications — drives budget/threshold alerts surfaced on KPI cards
- 4.25: React Query + TanStack Table — shared data layer, caching, and invalidation for KPI data
- 4.22/4.23: Weather & Local Events Correlation — optional seasonal/context badges on KPIs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation | Team |
| 2025-08-16 | 1.1 | Added real-time, dark mode, seasonal context | Enhancement |
