# Story 4.32: AI Service Integration

## Status
Ready for Development

## Story
**As a** property manager  
**I want** AI-powered insights and predictions in my analytics dashboard  
**So that** I can make proactive decisions based on intelligent analysis and forecasting  

## Acceptance Criteria

### Core AI Functionality
1. AI generates natural language insights from analytics data using Google Gemini API
2. System provides revenue and occupancy predictions for next 30/60/90 days with confidence intervals
3. AI detects statistical and pattern-based anomalies in booking trends, revenue, and expenses
4. Insights are contextual, actionable, and include specific recommendations with priority levels
5. AI responses are cached intelligently to minimize API costs with smart invalidation
6. System gracefully handles AI service failures with rule-based fallback insights
7. Insights update automatically when underlying data changes significantly (>5% variance)
8. AI provides confidence scores and uncertainty ranges for all predictions and insights

### Revenue & Booking Intelligence
9. AI analyzes booking source performance and recommends optimal channel allocation
10. System detects seasonal patterns and provides pricing optimization suggestions
11. AI identifies guest behavior trends (length of stay, repeat booking patterns, cancellation triggers)
12. System analyzes revenue per available room (RevPAR) trends and ADR optimization opportunities
13. AI provides conversion rate analysis and booking funnel optimization recommendations
14. System detects booking velocity changes and demand forecasting insights

### Expense & Budget Intelligence  
15. AI analyzes expense categories for cost optimization opportunities
16. System provides budget variance analysis with actionable expense management insights
17. AI identifies vendor spending patterns and negotiation opportunities
18. System detects unusual expense spikes and potential cost-saving measures
19. AI analyzes payment method efficiency and cash flow optimization
20. System provides expense forecasting based on historical patterns and seasonality

### Guest & Operations Intelligence
21. AI analyzes guest demographics and regional booking patterns for targeted marketing
22. System identifies repeat guest behavior and loyalty program optimization opportunities
23. AI detects cancellation and no-show patterns with prevention strategies
24. System analyzes occupancy patterns for operational efficiency recommendations
25. AI provides check-in/check-out optimization insights based on guest flow data
26. System identifies property comparison insights for competitive positioning

### Predictive Analytics & Forecasting
27. AI generates 30/60/90-day revenue forecasts with multiple scenario planning
28. System provides occupancy predictions accounting for seasonality and trends
29. AI forecasts expense budgets based on historical data and property growth
30. System predicts guest demand patterns for capacity planning
31. AI identifies potential revenue leakage and optimization opportunities
32. System provides early warning indicators for performance decline

## Tasks / Subtasks

- [ ] **Task 1: Core AI Service Architecture** (AC: 1, 5, 6, 8)
  - [ ] Create src/services/ai/AIService.ts with Google Gemini integration
  - [ ] Implement src/services/ai/PromptBuilder.ts for dynamic prompt generation
  - [ ] Create src/services/ai/AIResponseCache.ts with intelligent caching
  - [ ] Add src/services/ai/AIFallbackService.ts for rule-based insights
  - [ ] Implement rate limiting and cost tracking
  - [ ] Add configuration management for API keys and settings

- [ ] **Task 2: Revenue & Booking Intelligence** (AC: 9-14, 27-28)
  - [ ] Create src/services/ai/RevenueIntelligence.ts
  - [ ] Implement booking source performance analysis using sourceDistribution data
  - [ ] Add seasonal pattern detection from historical BookingKPIs
  - [ ] Create guest behavior analysis using ALOS, repeat guest rate metrics
  - [ ] Implement RevPAR and ADR trend analysis
  - [ ] Add booking velocity and demand forecasting
  - [ ] Create conversion rate optimization insights

- [ ] **Task 3: Expense & Budget Intelligence** (AC: 15-20, 29)
  - [ ] Create src/services/ai/ExpenseIntelligence.ts
  - [ ] Implement expense category optimization analysis
  - [ ] Add budget variance analysis using ExpenseBudgetComparison data
  - [ ] Create vendor spending pattern analysis
  - [ ] Implement unusual expense spike detection
  - [ ] Add payment method efficiency analysis
  - [ ] Create expense forecasting with seasonality

- [ ] **Task 4: Guest & Operations Intelligence** (AC: 21-26, 30)
  - [ ] Create src/services/ai/GuestIntelligence.ts
  - [ ] Implement guest demographics analysis using GuestDemographicsData
  - [ ] Add repeat guest behavior insights from repeatGuestRate metrics
  - [ ] Create cancellation pattern analysis using CancellationTrendData
  - [ ] Implement occupancy optimization recommendations
  - [ ] Add property comparison insights using PropertyComparisonData
  - [ ] Create guest demand pattern predictions

- [ ] **Task 5: Anomaly Detection & Early Warning** (AC: 3, 7, 31-32)
  - [ ] Create src/services/ai/AnomalyDetector.ts
  - [ ] Implement statistical anomaly detection for KPI metrics
  - [ ] Add pattern-based anomaly detection for booking trends
  - [ ] Create expense anomaly detection using budget variance thresholds
  - [ ] Implement early warning system for performance decline
  - [ ] Add revenue leakage detection algorithms
  - [ ] Create automated alerting for significant changes

- [ ] **Task 6: Predictive Analytics Engine** (AC: 2, 27-30)
  - [ ] Create src/services/ai/PredictiveAnalytics.ts
  - [ ] Implement time series forecasting for revenue using historical KPI data
  - [ ] Add occupancy prediction models using OccupancyTrendData
  - [ ] Create expense budget forecasting using ExpenseTrendData
  - [ ] Implement confidence interval calculations
  - [ ] Add scenario planning for multiple forecasts
  - [ ] Create capacity planning insights

- [ ] **Task 7: Smart Caching & Data Integration** (AC: 5, 7)
  - [ ] Implement cache invalidation strategy based on data change thresholds
  - [ ] Create data aggregation service for AI prompt preparation
  - [ ] Add incremental update detection using existing analytics hooks
  - [ ] Implement cost optimization and API usage monitoring
  - [ ] Create background job for pre-generating insights
  - [ ] Add cache warming strategies

- [ ] **Task 8: AI Insights UI Components** (AC: All)
  - [ ] Create src/components/Analytics/ai/AIInsightsPanel.tsx
  - [ ] Implement InsightCard components with action buttons
  - [ ] Add PredictionsChart for forecast visualization
  - [ ] Create AnomaliesAlert component for warnings
  - [ ] Implement confidence score visualizations
  - [ ] Add loading states and error handling
  - [ ] Create insight export functionality

- [ ] **Task 9: Integration with Existing Analytics** (AC: 4, 7)
  - [ ] Integrate with useKpiPeriod hook for real-time data
  - [ ] Connect to useDetailedExpenseAnalytics for expense insights
  - [ ] Utilize chartDataService for trend analysis
  - [ ] Implement hooks for AI insights (useAIInsights, useAIPredictions)
  - [ ] Add AI insights to FilterBar refresh functionality
  - [ ] Create seamless data flow from analytics to AI service

## Dev Notes

### AI Service Architecture
```typescript
export class AIService {
  private geminiClient: GoogleGenerativeAI;
  private cache: AIResponseCache;
  private rateLimiter: RateLimiter;
  
  constructor(config: AIConfig) {
    this.geminiClient = new GoogleGenerativeAI(config.apiKey);
    this.cache = new AIResponseCache(config.cacheConfig);
    this.rateLimiter = new RateLimiter(config.rateLimit);
  }

  async generateInsights(data: AnalyticsData): Promise<AIInsights> {
    // Check cache first
    const cached = await this.cache.get(data);
    if (cached && !this.isStale(cached)) {
      return cached;
    }
    
    // Rate limiting
    await this.rateLimiter.acquire();
    
    try {
      // Generate insights
      const insights = await this.processWithAI(data);
      
      // Cache results
      await this.cache.set(data, insights);
      
      return insights;
    } catch (error) {
      // Fallback to rule-based insights
      return this.generateFallbackInsights(data);
    }
  }

  private async processWithAI(data: AnalyticsData): Promise<AIInsights> {
    const model = this.geminiClient.getGenerativeModel({ 
      model: "gemini-1.5-pro" 
    });
    
    const prompt = this.buildPrompt(data);
    const result = await model.generateContent(prompt);
    
    return this.parseAIResponse(result.response.text());
  }
}
```

### Prompt Engineering
```typescript
export class PromptBuilder {
  buildInsightPrompt(data: AnalyticsData): string {
    return `
      You are an expert hospitality analytics consultant. Analyze the following property management data and provide actionable insights.
      
      CURRENT PERIOD DATA (${data.period.start} to ${data.period.end}):
      - Total Revenue: ₹${data.revenue.total}
      - Occupancy Rate: ${data.occupancy.rate}%
      - Average Daily Rate: ₹${data.metrics.adr}
      - Total Bookings: ${data.bookings.total}
      - Cancellation Rate: ${data.metrics.cancellationRate}%
      
      REVENUE BREAKDOWN:
      ${Object.entries(data.revenue.bySource)
        .map(([source, amount]) => `- ${source}: ₹${amount}`)
        .join('\n')}
      
      COMPARISON TO PREVIOUS PERIOD:
      - Revenue Change: ${data.comparison.revenue.change}%
      - Occupancy Change: ${data.comparison.occupancy.change}%
      
      Provide insights in the following JSON format:
      {
        "summary": "Brief executive summary (2-3 sentences)",
        "insights": [
          {
            "type": "trend|opportunity|warning|success",
            "title": "Short title",
            "description": "Detailed insight",
            "impact": "high|medium|low",
            "recommendation": "Specific action to take"
          }
        ],
        "metrics": {
          "revenueHealth": "excellent|good|fair|poor",
          "occupancyTrend": "improving|stable|declining",
          "actionPriority": "Array of top 3 actions"
        }
      }
      
      Focus on:
      1. Identifying significant trends or patterns
      2. Highlighting opportunities for revenue optimization
      3. Warning about potential issues
      4. Providing specific, actionable recommendations
      5. Considering seasonal factors and local events
    `;
  }

  buildPredictionPrompt(historicalData: TimeSeriesData): string {
    return `
      Based on the following historical booking and revenue data, predict the next 30 days performance.
      
      HISTORICAL DATA (Last 90 days):
      ${this.formatTimeSeriesData(historicalData)}
      
      CONTEXT:
      - Property Type: ${historicalData.propertyType}
      - Location: Manali, Himachal Pradesh
      - Seasonal Patterns: ${this.identifySeasonality(historicalData)}
      - Current Month: ${new Date().toLocaleString('default', { month: 'long' })}
      
      Provide predictions in JSON format:
      {
        "revenue": {
          "forecast": [daily predictions for 30 days],
          "total": predicted total,
          "confidence": 0-1 score,
          "factors": ["list of influencing factors"]
        },
        "occupancy": {
          "forecast": [daily predictions for 30 days],
          "average": predicted average,
          "peakDays": ["dates with high occupancy"],
          "lowDays": ["dates with low occupancy"]
        },
        "recommendations": [
          "Specific actions based on predictions"
        ]
      }
    `;
  }
}
```

### Predictive Analytics Implementation
```typescript
export class PredictiveAnalytics {
  private model: GenerativeModel;
  private historicalData: HistoricalDataStore;
  
  async predictRevenue(
    data: AnalyticsData,
    days: number = 30
  ): Promise<RevenuePrediction> {
    // Prepare time series data
    const timeSeries = await this.prepareTimeSeries(data);
    
    // Apply seasonality adjustments
    const seasonalFactors = this.calculateSeasonality(timeSeries);
    
    // Generate AI prediction
    const aiPrediction = await this.getAIPrediction(timeSeries, days);
    
    // Apply statistical validation
    const validated = this.validatePrediction(aiPrediction, timeSeries);
    
    // Calculate confidence intervals
    const confidence = this.calculateConfidence(validated, timeSeries);
    
    return {
      daily: validated.daily,
      total: validated.total,
      confidence: confidence.score,
      intervals: confidence.intervals,
      factors: this.identifyInfluencingFactors(timeSeries)
    };
  }

  private calculateSeasonality(data: TimeSeriesData): SeasonalFactors {
    // Detect weekly patterns
    const weeklyPattern = this.detectWeeklyPattern(data);
    
    // Detect monthly patterns
    const monthlyPattern = this.detectMonthlyPattern(data);
    
    // Detect holiday impacts
    const holidayImpact = this.detectHolidayImpact(data);
    
    return {
      weekly: weeklyPattern,
      monthly: monthlyPattern,
      holidays: holidayImpact,
      strength: this.calculateSeasonalityStrength(data)
    };
  }

  private calculateConfidence(
    prediction: Prediction,
    historical: TimeSeriesData
  ): ConfidenceMetrics {
    // Calculate based on:
    // 1. Historical data variance
    const variance = this.calculateVariance(historical);
    
    // 2. Sample size
    const sampleScore = Math.min(historical.length / 365, 1);
    
    // 3. Prediction stability
    const stability = this.assessPredictionStability(prediction);
    
    // 4. Model accuracy on validation set
    const accuracy = this.validateAgainstHistory(prediction, historical);
    
    const overallScore = (
      variance * 0.3 +
      sampleScore * 0.2 +
      stability * 0.25 +
      accuracy * 0.25
    );
    
    return {
      score: overallScore,
      intervals: this.calculatePredictionIntervals(prediction, overallScore)
    };
  }
}
```

### Anomaly Detection
```typescript
export class AnomalyDetector {
  private thresholds: AnomalyThresholds;
  
  async detectAnomalies(data: AnalyticsData): Promise<Anomaly[]> {
    const anomalies: Anomaly[] = [];
    
    // Statistical anomalies
    const statistical = this.detectStatisticalAnomalies(data);
    anomalies.push(...statistical);
    
    // Pattern anomalies
    const patterns = await this.detectPatternAnomalies(data);
    anomalies.push(...patterns);
    
    // Business rule anomalies
    const businessRules = this.detectBusinessRuleViolations(data);
    anomalies.push(...businessRules);
    
    // AI-detected anomalies
    const aiDetected = await this.detectWithAI(data);
    anomalies.push(...aiDetected);
    
    // Rank by severity
    return this.rankAnomalies(anomalies);
  }

  private detectStatisticalAnomalies(data: AnalyticsData): Anomaly[] {
    const anomalies: Anomaly[] = [];
    
    // Z-score based detection
    const metrics = this.extractMetrics(data);
    
    for (const [metric, value] of Object.entries(metrics)) {
      const stats = this.getHistoricalStats(metric);
      const zScore = (value - stats.mean) / stats.stdDev;
      
      if (Math.abs(zScore) > 3) {
        anomalies.push({
          type: 'statistical',
          metric,
          value,
          expected: stats.mean,
          severity: this.calculateSeverity(zScore),
          description: `${metric} is ${zScore > 0 ? 'unusually high' : 'unusually low'}`,
          recommendation: this.getRecommendation(metric, zScore)
        });
      }
    }
    
    return anomalies;
  }

  private async detectWithAI(data: AnalyticsData): Promise<Anomaly[]> {
    const prompt = `
      Analyze this data for anomalies that might not be caught by statistical methods:
      ${JSON.stringify(data, null, 2)}
      
      Look for:
      1. Unusual booking patterns
      2. Suspicious cancellation clusters
      3. Abnormal expense patterns
      4. Channel performance irregularities
      
      Return anomalies in JSON format with severity and recommendations.
    `;
    
    const response = await this.aiService.analyze(prompt);
    return this.parseAIAnomalies(response);
  }
}
```

### Caching Strategy
```typescript
export class AIResponseCache {
  private cache: Map<string, CachedResponse> = new Map();
  private ttl: number = 3600000; // 1 hour default
  
  async get(data: AnalyticsData): Promise<AIInsights | null> {
    const key = this.generateCacheKey(data);
    const cached = this.cache.get(key);
    
    if (!cached) return null;
    
    // Check if stale
    if (Date.now() - cached.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    // Check if data has significantly changed
    if (this.hasSignificantChange(data, cached.sourceData)) {
      this.cache.delete(key);
      return null;
    }
    
    return cached.response;
  }

  private hasSignificantChange(
    current: AnalyticsData,
    cached: AnalyticsData
  ): boolean {
    // Define significance thresholds
    const thresholds = {
      revenue: 0.1,      // 10% change
      bookings: 5,       // 5 booking difference
      occupancy: 0.05    // 5% occupancy change
    };
    
    // Check each metric
    const revenueChange = Math.abs(
      (current.revenue.total - cached.revenue.total) / cached.revenue.total
    );
    
    if (revenueChange > thresholds.revenue) return true;
    
    const bookingDiff = Math.abs(
      current.bookings.total - cached.bookings.total
    );
    
    if (bookingDiff > thresholds.bookings) return true;
    
    // Continue for other metrics...
    
    return false;
  }
}
```

### UI Components
```typescript
export const AIInsightsPanel: React.FC = () => {
  const { data, isLoading, error } = useAIInsights();
  
  if (isLoading) return <InsightsSkeleton />;
  if (error) return <InsightsFallback error={error} />;
  
  return (
    <div className="space-y-4">
      {/* Executive Summary */}
      <Card className="bg-gradient-to-br from-blue-50 to-indigo-50">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Brain className="h-5 w-5 text-blue-600" />
            AI Summary
          </CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-gray-700">{data.summary}</p>
        </CardContent>
      </Card>
      
      {/* Insights Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {data.insights.map((insight) => (
          <InsightCard
            key={insight.id}
            insight={insight}
            onAction={handleInsightAction}
          />
        ))}
      </div>
      
      {/* Predictions Chart */}
      <PredictionsChart predictions={data.predictions} />
      
      {/* Anomalies Alert */}
      {data.anomalies.length > 0 && (
        <AnomaliesAlert anomalies={data.anomalies} />
      )}
    </div>
  );
};
```

### Error Handling and Fallbacks
```typescript
export class AIFallbackService {
  generateFallbackInsights(data: AnalyticsData): AIInsights {
    // Rule-based insights when AI is unavailable
    const insights: Insight[] = [];
    
    // Revenue analysis
    if (data.comparison.revenue.change > 10) {
      insights.push({
        type: 'success',
        title: 'Strong Revenue Growth',
        description: `Revenue increased by ${data.comparison.revenue.change}%`,
        impact: 'high',
        recommendation: 'Maintain current strategies and consider capacity expansion'
      });
    }
    
    // Occupancy analysis
    if (data.occupancy.rate < 60) {
      insights.push({
        type: 'warning',
        title: 'Low Occupancy Alert',
        description: `Occupancy at ${data.occupancy.rate}% is below optimal`,
        impact: 'high',
        recommendation: 'Consider promotional pricing or marketing campaigns'
      });
    }
    
    // Add more rule-based insights...
    
    return {
      summary: 'AI insights temporarily unavailable. Showing rule-based analysis.',
      insights,
      metrics: this.calculateBasicMetrics(data),
      generated: new Date(),
      confidence: 0.6
    };
  }
}
```

### Mock AI Responses
```typescript
const mockAIResponses = {
  insights: {
    summary: "Revenue showing strong growth...",
    insights: [
      {
        type: 'trend',
        title: 'Positive Revenue Trend',
        description: 'Revenue has increased 15% month-over-month',
        impact: 'high',
        recommendation: 'Maintain current pricing strategy'
      }
    ]
  },
  predictions: {
    revenue: {
      forecast: [/* 30 days of predictions */],
      confidence: 0.85
    }
  },
  anomalies: [
    {
      type: 'statistical',
      metric: 'cancellation_rate',
      severity: 'medium'
    }
  ]
};
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Analytics Team |

---

## Linked Issues
- Depends on: Stories 4.29-4.31 (Analytics Integration)
- Enhances: All analytics dashboard components
- Related: Story 4.11 (Predictive Features)
