# Status
Completed

# Story: Booking Charges & Payments â€” Services
Create Supabase client services for CRUD on charges and payments.

## Prerequisites
- Schema and RLS in place (`7.1`).
- Dual Supabase client pattern as in existing services.

## Acceptance Criteria
- `src/services/bookingChargesService.ts` with functions: listByBooking, createFoodCharge, createMiscCharge, update, void.
- `src/services/bookingPaymentsService.ts` with functions: listByBooking, addPayment, addRefund, void.
- All calls are property-scoped and respect RLS.
- Basic unit tests or test harness to validate service behaviors.

 - Enforce allowed types and booking property consistency (fail fast in service; DB triggers will enforce too).

## Tasks
- [x] Implement `bookingChargesService.ts` and `bookingPaymentsService.ts` modeled on `menuService.ts` style.
- [x] Add validation for input (qty > 0, prices >= 0).
- [x] Discounts are separate rows with `charge_type = 'discount'`; there are no per-line discount fields. Compute net/effective totals for display only if needed; authoritative totals come from the `booking_financials` view.
- [x] Add small utility to compute effective per-line total if needed by UI.

## Dev Notes
- Use `src/lib/supabase/index.ts` unified client for instantiation/imports.
- Consider pagination for large lists, though UI likely per-booking small sets.
 - Validate `charge_type`/`payment_type` against allowed values and ensure child `property_id` matches parent booking before calling DB (fast failure, clearer errors).
 - For tests, set property scope using `select set_config('request.jwt.claims', json_build_object('role','authenticated','property_id','<uuid>')::text, true);`.

## Implementation Notes
- `src/services/bookingChargesService.ts` implements: `listByBooking`, `createFoodCharge`, `createMiscCharge`, `update`, `void`.
- `src/services/bookingPaymentsService.ts` implements: `listByBooking`, `addPayment`, `addRefund`, `void`.
- All operations verify booking scope via a `bookings` lookup and rely on RLS for enforcement.
- Input validation added:
  - Charges: `quantity > 0`, `unitAmount >= 0`. `amount` computed via `computeLineTotal()` and recomputed on updates.
  - Payments/Refunds: `amount > 0`.
- Supabase client is imported from `../lib/supabase/index` in both services; tests mock this path to avoid real network calls.

## Valid types
- `booking_charges.charge_type`: `room`, `fnb`, `misc`, `discount`, `tax`, `service_fee`
- `booking_payments.payment_type`: `payment`, `refund`, `adjustment`

## Testing
- Unit tests added for service behaviors with mocked Supabase client:
  - `src/tests/unit/services/bookingChargesService.test.ts` (4 tests)
  - `src/tests/unit/services/bookingPaymentsService.test.ts` (4 tests)
- All 8 tests passed locally. Commands used:
  - `npx vitest run src\tests\unit\services\bookingChargesService.test.ts`
  - `npx vitest run src\tests\unit\services\bookingPaymentsService.test.ts`
- Tests verify property-scoped listing, creation, updates with amount recomputation, and soft-void logic. Mocks target `../../../lib/supabase/index`.
- For future integration tests against a real DB, use `set_config('request.jwt.claims', ...)` to simulate property scope and validate RLS.

## Change Log
- 2025-08-22: Story drafted.
- 2025-08-23: Implemented services and unit tests; all tests passing. Story marked Completed.
